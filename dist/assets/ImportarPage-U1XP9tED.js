import{f as Js,u as Qs,d as Zs,j as e,B as G,e as er,b as sr,i as we,W as Ee,S as oe,A as M,n,G as C,X as hs,p as Y,m as j,q as rr,v as qe,r as l,N as $e,x as ar,Y as or,Z as tr,O as lr,z as x,_ as Se,P as us,$ as re,a0 as nr,t as ae,V as ir,w as ms,U as cr,a1 as dr,T as hr}from"./index-B9r5cl9W.js";import{g as ps}from"./casosApi-BKSmOZmE.js";import{I as xs,g as gs,v as ur,u as js,d as mr}from"./archivosApi-BN2_ETYT.js";import{r as pr,u as _e,w as xr}from"./xlsx-CwpDMyS9.js";import{I as fs}from"./IconInfoCircle-CeWkeBUc.js";import{a as o,S as de,T as vs}from"./Table-D9CHl7vx.js";import{B as ue}from"./Badge-0g_QzpBM.js";import{L as gr}from"./LoadingOverlay-CxXc0-rV.js";import{I as he,F as jr}from"./IconUpload-C-eXztvs.js";import{G as Ge}from"./Grid-yhenIOJ3.js";import{I as fr}from"./IconDownload-CiLVSNyg.js";import{D as Oe}from"./Divider-tgUTFFpg.js";import{S as bs}from"./SimpleGrid-D2l_HKT_.js";import{C as vr}from"./Checkbox-B2UTVamD.js";var Cs={root:"m_18320242","skeleton-fade":"m_299c329c"};const br={visible:!0,animate:!0},Cr=er((O,{width:L,height:y,radius:A,circle:F})=>({root:{"--skeleton-height":we(y),"--skeleton-width":F?we(y):we(L),"--skeleton-radius":F?"1000px":A===void 0?void 0:sr(A)}})),k=Js((O,L)=>{const y=Qs("Skeleton",br,O),{classNames:A,className:F,style:q,styles:i,unstyled:H,vars:te,width:E,height:c,circle:W,visible:h,radius:w,animate:le,mod:N,...Te}=y,Ie=Zs({name:"Skeleton",classes:Cs,props:y,className:F,style:q,classNames:A,styles:i,unstyled:H,vars:te,varsResolver:Cr});return e.jsx(G,{ref:L,...Ie("root"),mod:[{visible:h,animate:le},N],...Te})});k.classes=Cs;k.displayName="@mantine/core/Skeleton";const Sr=({opened:O,onClose:L,onConfirm:y,validacionData:A,loading:F})=>{if(!A)return null;const{total_registros:q,lectores_nuevos:i,lectores_problematicos:H,lectores_existentes:te,es_seguro_proceder:E,advertencias:c}=A,W=()=>{E&&y()};return e.jsx(Ee,{opened:O,onClose:L,title:e.jsxs(C,{gap:"sm",children:[e.jsx(fs,{size:20}),e.jsx(qe,{order:4,children:"Confirmación de Lectores"})]}),size:"lg",centered:!0,children:e.jsxs(oe,{gap:"md",children:[e.jsxs(M,{color:E?"blue":"red",icon:E?e.jsx(fs,{}):e.jsx(xs,{}),children:[e.jsxs(n,{size:"sm",fw:500,children:["Se procesarán ",q," registros del archivo."]}),c.map((h,w)=>e.jsxs(n,{size:"sm",mt:"xs",children:["• ",h]},w))]}),H.length>0&&e.jsxs(G,{children:[e.jsxs(C,{gap:"sm",mb:"sm",children:[e.jsx(xs,{size:18,color:"red"}),e.jsxs(n,{fw:600,c:"red",children:["Lectores Problemáticos (",H.length,")"]})]}),e.jsxs(M,{color:"red",variant:"light",children:[e.jsx(n,{size:"sm",mb:"sm",children:"Los siguientes lectores parecen matrículas de vehículos y no se crearán:"}),e.jsx(hs.Autosize,{mah:150,children:e.jsxs(o,{children:[e.jsx(o.Thead,{children:e.jsxs(o.Tr,{children:[e.jsx(o.Th,{children:"ID Lector"}),e.jsx(o.Th,{children:"Problema"})]})}),e.jsx(o.Tbody,{children:H.map(h=>e.jsxs(o.Tr,{children:[e.jsx(o.Td,{children:e.jsx(n,{ff:"monospace",size:"sm",children:h.id})}),e.jsx(o.Td,{children:e.jsx(n,{size:"xs",c:"red",children:h.razon})})]},h.id))})]})})]})]}),i.length>0&&e.jsxs(G,{children:[e.jsxs(C,{gap:"sm",mb:"sm",children:[e.jsx(Y,{size:18,color:"green"}),e.jsxs(n,{fw:600,c:"green",children:["Lectores Nuevos (",i.length,")"]})]}),e.jsxs(M,{color:"green",variant:"light",children:[e.jsx(n,{size:"sm",mb:"sm",children:"Se crearán automáticamente los siguientes lectores:"}),e.jsx(hs.Autosize,{mah:150,children:e.jsxs(o,{children:[e.jsx(o.Thead,{children:e.jsxs(o.Tr,{children:[e.jsx(o.Th,{children:"ID Lector"}),e.jsx(o.Th,{children:"Estado"})]})}),e.jsx(o.Tbody,{children:i.map(h=>e.jsxs(o.Tr,{children:[e.jsx(o.Td,{children:e.jsx(n,{ff:"monospace",size:"sm",children:h.id})}),e.jsx(o.Td,{children:e.jsx(ue,{color:"green",size:"sm",children:"Nuevo"})})]},h.id))})]})})]})]}),te.length>0&&e.jsxs(G,{children:[e.jsxs(C,{gap:"sm",mb:"sm",children:[e.jsx(Y,{size:18,color:"blue"}),e.jsxs(n,{fw:600,c:"blue",children:["Lectores Existentes (",te.length,")"]})]}),e.jsx(n,{size:"sm",c:"dimmed",children:"Se utilizarán los lectores ya existentes en el sistema."})]}),e.jsxs(C,{justify:"space-between",mt:"md",children:[e.jsx(j,{variant:"outline",onClick:L,leftSection:e.jsx(rr,{size:16}),children:"Cancelar"}),e.jsx(j,{onClick:W,disabled:!E,loading:F,leftSection:e.jsx(Y,{size:16}),color:E?"green":"red",children:E?"Continuar Importación":"No se puede continuar"})]}),!E&&e.jsx(M,{color:"red",variant:"light",children:e.jsxs(n,{size:"sm",children:[e.jsx("strong",{children:"Importación bloqueada:"})," Se detectaron lectores problemáticos que parecen matrículas. Revisa el archivo y corrige los datos antes de continuar."]})})]})})},U={LPR:["Matricula","Fecha","Hora","ID_Lector"],GPS:["Matricula","Fecha","Hora"],GPX_KML:["Fecha","Hora","Coordenada_X","Coordenada_Y"]},ye={LPR:["Carril","Sentido","Velocidad","Coordenada_X","Coordenada_Y"],GPS:["ID_Lector","Sentido","Velocidad","Coordenada_X","Coordenada_Y"],GPX_KML:["Velocidad","Altitud","Precision"]},_r={Matricula:["matricula","matrícula","plate","license","licensenumber","numplaca","patente","licenseplate"],Fecha:["fecha","date","fec"],Hora:["hora","time","timestamp"],ID_Lector:["id_lector","idlector","lector","camara","cámara","device","reader","dispositivo","camera","cam","cam_id","device_id","deviceid","reader_id","readerid","sensor","detector","scanner","scanner_id","scannerid","equipo","equipment","equipment_id","equipmentid","unidad","unit","unit_id","unitid","terminal","terminal_id","terminalid","estacion","station","station_id","stationid","punto","point","point_id","pointid","nodo","node","node_id","nodeid","devicename","device_name","device-name","devicename_id","device_name_id","nombre_dispositivo","nombre_equipo","nombre_lector","nombre_camara"],Coordenada_X:["coordenada_x","coord_x","coordx","longitud","longitude","lon","x","este","easting"],Coordenada_Y:["coordenada_y","coord_y","coordy","latitud","latitude","lat","y","norte","northing"],Velocidad:["velocidad","speed","vel","v","kmh"],Carril:["carril","lane","via"]};function Nr(){const[O,L]=l.useState([]),[y,A]=l.useState(!0),[F,q]=l.useState(null),[i,H]=l.useState(null),[te,E]=l.useState(null),[c,W]=l.useState("LPR"),[h,w]=l.useState(null),[le,N]=l.useState([]),[Te,{open:Ie,close:Me}]=$e(!1),[X,R]=l.useState({}),[B,V]=l.useState(!1),[Xe,J]=l.useState(null),[T,me]=l.useState(!1),[Be,D]=l.useState(null),[pe,K]=l.useState(0),[P,ne]=l.useState([]),[Ae,De]=l.useState(!1),[Ve,Pe]=l.useState(null),[Ke,Ue]=l.useState(null),[We,Je]=l.useState(0),Ss=ar(),Qe=or(),[_s,xe]=l.useState(null),[ys,{open:ze,close:Le}]=$e(!1);l.useEffect(()=>{os.current=ze},[ze]);const[ke,Ze]=l.useState(""),[ws,Es]=l.useState([]),[Ts,ge]=l.useState(!1),[v,je]=l.useState(null),[ie,Is]=l.useState(!1),[Ye,Ms]=l.useState("DD/MM/YYYY HH:mm:ss"),{addTask:As}=tr(),[yr,Fe]=l.useState(null),{getToken:Ds}=lr(),[Ps,{open:zs,close:es}]=$e(!1),[Ls,He]=l.useState(null),[ss,rs]=l.useState(!1),[ks,Ys]=l.useState(!0),[as,g]=l.useState(null),[Ne,Fs]=l.useState(!1),fe=l.useRef(!1),Re=l.useRef(!1),os=l.useRef(ze);l.useEffect(()=>{(async()=>{var a,d,u;const r=(a=Qe.state)==null?void 0:a.preselectedCasoId,t=r!=null;if(Fs(t),A(!0),q(null),t){x.show({id:"config-automatica",title:"Configuración Automática Activada",message:"Preparando importación para el caso seleccionado...",color:"green",icon:e.jsx(Y,{size:18}),autoClose:!1,loading:!0});try{const m=x.show({id:"carga-paralela",title:"Carga Optimizada en Progreso",message:"Cargando casos y archivos en paralelo...",color:"blue",icon:e.jsx(he,{size:18}),autoClose:!1,loading:!0}),[S,p]=await Promise.all([ps(),gs(String(r)).catch(()=>[])]),I=S.map(_=>({value:_.ID_Caso.toString(),label:`${_.ID_Caso} - ${_.Nombre_del_Caso} (${_.Año})`}));L(I);const z=String(r);if(I.some(_=>_.value===z)){H(z);const _=(d=I.find(b=>b.value===z))==null?void 0:d.label;_&&E(((u=_.split(" - ")[1])==null?void 0:u.split(" (")[0])||"Caso seleccionado"),Array.isArray(p)&&(ne(p),De(!1),fe.current=!0)}x.hide("carga-paralela"),x.update({id:"config-automatica",title:"Configuración Completada",message:`Caso seleccionado automáticamente. ${Array.isArray(p)?p.length:0} archivos cargados.`,color:"green",icon:e.jsx(Y,{size:18}),autoClose:4e3,loading:!1}),g(null)}catch(m){console.error("Error in preselected flow:",m),x.hide("carga-paralela"),x.update({id:"config-automatica",title:"Error en Configuración",message:"Error al cargar los datos del caso. Intente refrescar la página.",color:"red",icon:e.jsx(ae,{size:18}),autoClose:6e3,loading:!1}),q("Error al cargar los datos del caso. Intente refrescar la página."),g(null)}}else{g("Cargando lista de casos...");try{const S=(await ps()).map(p=>({value:p.ID_Caso.toString(),label:`${p.ID_Caso} - ${p.Nombre_del_Caso} (${p.Año})`}));L(S),g(null)}catch(m){console.error("Error fetching casos:",m),q("Error al cargar la lista de casos. Verifique su conexión e intente nuevamente."),g(null)}}A(!1),Ys(!1)})()},[Qe.state]);const Q=l.useCallback(async(s,r=!1)=>{if(!Re.current){Re.current=!0,De(!0),Pe(null),g("Cargando archivos del caso...");try{const t=await gs(s);ne(t),Je(0),fe.current=!0,r&&x.show({title:"Archivos Actualizados",message:`Se cargaron ${t.length} archivos del caso.`,color:"blue",autoClose:3e3})}catch(t){console.error("Error fetching archivos:",t),Pe("Error al cargar los archivos. Intente refrescar la lista."),ne([]),Je(a=>a+1)}finally{De(!1),g(null),Re.current=!1}}},[]);l.useEffect(()=>{i?(!Ne||!fe.current)&&Q(i):i||(ne([]),Pe(null),fe.current=!1)},[i,Ne,Q]);const Hs=async s=>new Promise((r,t)=>{const a=new FileReader;a.onload=async d=>{var u,m;try{const S=(u=d.target)==null?void 0:u.result;if(!S)throw new Error("No se pudo leer el archivo");let p=[];if(s.name.toLowerCase().endsWith(".gpx")){const _=new DOMParser().parseFromString(S,"text/xml").getElementsByTagName("trkpt");p=Array.from(_).map(b=>{var is,cs,ds;const Z=parseFloat(b.getAttribute("lat")||"0"),ee=parseFloat(b.getAttribute("lon")||"0"),f=((is=b.getElementsByTagName("time")[0])==null?void 0:is.textContent)||"",$=((cs=b.getElementsByTagName("ele")[0])==null?void 0:cs.textContent)||"",ce=((ds=b.getElementsByTagName("speed")[0])==null?void 0:ds.textContent)||"",se=new Date(f);return{Fecha:se.toISOString().split("T")[0],Hora:se.toTimeString().split(" ")[0],Coordenada_X:ee,Coordenada_Y:Z,Altitud:$?parseFloat($):null,Velocidad:ce?parseFloat(ce):null}})}else s.name.toLowerCase().endsWith(".kml")&&(p=(((m=new DOMParser().parseFromString(S,"text/xml").getElementsByTagName("coordinates")[0])==null?void 0:m.textContent)||"").split(" ").filter(b=>b.trim()).map(b=>{const[Z,ee,f]=b.split(",").map(Number),$=new Date;return{Fecha:$.toISOString().split("T")[0],Hora:$.toTimeString().split(" ")[0],Coordenada_X:Z,Coordenada_Y:ee,Altitud:f||null}}));if(p.length===0)throw new Error("No se encontraron puntos en el archivo");const I=Object.keys(p[0]);r({headers:I,data:p})}catch(S){t(S)}},a.onerror=()=>{t(new Error("Error al leer el archivo"))},a.readAsText(s)}),ts=l.useCallback(async s=>{V(!0),N([]),R({}),J(null),g("Analizando estructura del archivo...");try{if(c==="GPX_KML"){const{headers:r,data:t}=await Hs(s);N(r);const a={};[...U[c],...ye[c]].forEach(u=>{a[u]=r.find(m=>m===u)||null}),R(a),Es(t),x.show({title:"Archivo Procesado",message:`Se procesaron ${t.length} puntos del archivo ${s.name.toLowerCase().endsWith(".gpx")?"GPX":"KML"}.`,color:"blue",autoClose:5e3}),os.current()}else{const r=new FileReader;r.onload=t=>{var a;try{const d=(a=t.target)==null?void 0:a.result;if(!d)throw new Error("No se pudo leer el archivo");g("Procesando columnas del archivo...");const u=pr(d,{type:"array"}),m=u.SheetNames[0],S=u.Sheets[m],p=_e.sheet_to_json(S,{header:1});if(p&&p.length>0){const I=p[0].map(f=>String(f||"").trim()).filter(f=>f.length>0);N(I);const z={},Ce=[...U[c],...ye[c]],_=I.map(f=>f.toLowerCase()),b=new Set;Ce.forEach(f=>{z[f]=null;const $=_r[f];if($)for(const ce of I){const se=ce.toLowerCase();if($.includes(se)&&!b.has(se)){z[f]=ce,b.add(se);break}}}),R(z);const Z=Object.values(z).filter(f=>f!==null).length,ee=U[c].length;x.show({title:"Archivo Analizado",message:`Se mapearon automáticamente ${Z} de ${ee} campos requeridos.`,color:Z===ee?"green":"blue",autoClose:5e3})}else throw new Error("El archivo Excel está vacío o no tiene cabeceras.")}catch(d){J(`Error al leer las cabeceras: ${d.message}`),x.show({title:"Error de Lectura",message:`No se pudieron leer las cabeceras: ${d.message}`,color:"red"}),w(null)}finally{V(!1),g(null)}},r.onerror=()=>{J("Error al leer el archivo."),x.show({title:"Error de Archivo",message:"Ocurrió un error al intentar leer el archivo seleccionado.",color:"red"}),w(null),V(!1),g(null)},r.readAsArrayBuffer(s)}}catch(r){J(`Error al procesar el archivo: ${r.message}`),x.show({title:"Error de Procesamiento",message:r.message,color:"red"}),w(null),V(!1),g(null)}},[c]);l.useEffect(()=>{h?ts(h):(N([]),R({}),J(null))},[h,ts]),l.useEffect(()=>{if(h){const s={};U[c].forEach(r=>s[r]=null),ye[c].forEach(r=>s[r]=null),R(s)}},[c,h]);const ve=(s,r)=>{R(t=>({...t,[s]:r}))},Ns=()=>{const s=U[c].filter(r=>!X[r]);if(s.length>0){x.show({title:"Mapeo Incompleto",message:`Debes seleccionar una columna del Excel para los siguientes campos requeridos: ${s.join(", ")}`,color:"orange"});return}x.show({title:"Mapeo Guardado",message:"La configuración del mapeo se ha guardado.",color:"teal",icon:e.jsx(Y,{size:18})}),Me()},ls=()=>U[c].every(s=>!!X[s]),Rs=(s,r)=>s.map(t=>({...t,Matricula:r})),$s=async()=>{var s,r;if(!h||!i){D("Por favor, seleccione un archivo y un caso.");return}if(c!=="LPR"){be();return}rs(!0),D(null),g("Validando lectores del archivo...");try{const t=Object.entries(X).filter(([d,u])=>u!==null).reduce((d,[u,m])=>(d[u]=m,d),{});ie&&(t.formato_fecha_hora=Ye);const a=await ur(i,c,h,JSON.stringify(t));if(He(a),a.error){D(`Error en validación: ${a.error}`);return}a.es_seguro_proceder&&a.lectores_nuevos.length===0&&a.lectores_problematicos.length===0?be():zs()}catch(t){console.error("Error en validación de lectores:",t),D(`Error al validar lectores: ${((r=(s=t.response)==null?void 0:s.data)==null?void 0:r.detail)||t.message}`)}finally{rs(!1),g(null)}},be=async()=>{var s,r;if(!h||!i){D("Por favor, seleccione un archivo y un caso.");return}D(null),xe(null),me(!0),K(0),g("Preparando archivo para importación...");try{const t=Object.entries(X).filter(([d,u])=>u!==null).reduce((d,[u,m])=>(d[u]=m,d),{});ie&&(t.formato_fecha_hora=Ye),g("Subiendo archivo al servidor..."),K(25);let a;if(c==="GPX_KML"){const d=Rs(ws,ke),u=_e.json_to_sheet(d),m=_e.book_new();_e.book_append_sheet(m,u,"Datos");const S=xr(m,{bookType:"xlsx",type:"array"}),p=new Blob([S],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),I=new File([p],h.name.replace(/\.(gpx|kml)$/i,".xlsx"),{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});g("Procesando datos GPS..."),K(50),a=await js(i,"GPS",I,JSON.stringify(t))}else g("Procesando datos del archivo..."),K(50),a=await js(i,c,h,JSON.stringify(t));K(75),g("Finalizando importación..."),a!=null&&a.task_id&&(As({id:a.task_id,onComplete:Gs,onError:Os}),Fe(a.task_id)),K(100),!a||!a.archivo?(xe(e.jsxs(M,{color:"blue",title:"Procesando archivo...",icon:e.jsx(he,{}),mt:"md",children:["El archivo se está procesando en segundo plano. Aparecerá en la lista de archivos importados en unos momentos.",e.jsx(Se,{value:100,mt:"sm",animated:!0})]})),setTimeout(()=>{Q(i,!0)},5e3)):(Q(i,!0),x.show({title:"Importación Exitosa",message:"El archivo ha sido importado correctamente.",color:"green",icon:e.jsx(Y,{size:18})})),w(null),N([]),R({}),Ze("")}catch(t){let a="Error al importar el archivo.",d=(r=(s=t.response)==null?void 0:s.data)==null?void 0:r.detail;if(d)try{typeof d=="string"?a=`${a} Detalle: ${d}`:a=`${a} Detalle: 
${JSON.stringify(d,null,2)}`}catch{a=`${a} (No se pudo formatear detalle del error)`}else t.message&&(a=`${a} Mensaje: ${t.message}`);a.length>500&&(a=a.substring(0,497)+"..."),D(a)}finally{me(!1),V(!1),K(0),g(null)}},Gs=s=>{x.show({title:"Importación Completada",message:`Se procesaron ${s.total_registros} registros correctamente.`,color:"green",icon:e.jsx(Y,{size:18})}),i&&Q(i),Fe(null)},Os=s=>{x.show({title:"Error en la Importación",message:s,color:"red",icon:e.jsx(ae,{size:18})}),Fe(null)},qs=()=>{es(),He(null),be()},Xs=()=>{es(),He(null)},Bs=async s=>{const r=P.find(t=>t.ID_Archivo===s)||null;je(r),ge(!0)},Vs=async()=>{var s,r;if(v){Ue(v.ID_Archivo),ge(!1);try{await mr(v.ID_Archivo),x.show({title:"Archivo Eliminado",message:`El archivo ID ${v.ID_Archivo} ha sido eliminado correctamente.`,color:"teal",icon:e.jsx(Y,{size:18})}),ne(t=>t.filter(a=>a.ID_Archivo!==v.ID_Archivo))}catch(t){console.error("Error al eliminar archivo:",t),x.show({title:"Error al Eliminar",message:((r=(s=t.response)==null?void 0:s.data)==null?void 0:r.detail)||t.message||"No se pudo eliminar el archivo.",color:"red",icon:e.jsx(ae,{})})}finally{Ue(null),je(null)}}};l.useEffect(()=>{xe(null)},[h,i,c]);const Ks=s=>{var a;if(!s)return;const r=(a=s.name.split(".").pop())==null?void 0:a.toLowerCase();let t=[];if(c==="GPX_KML"?t=["gpx","kml"]:t=["xlsx","xls","csv"],!t.includes(r||"")){D(c==="GPX_KML"?"Por favor, seleccione un archivo GPX (.gpx) o KML (.kml) válido.":"Por favor, seleccione un archivo Excel (.xlsx, .xls) o CSV (.csv) válido.");return}w(s),D(null),xe(null)},Us=async(s,r)=>{try{const t=Ds(),a=await fetch(`/api/archivos/${s}/download`,{headers:{Authorization:`Bearer ${t}`}});if(!a.ok)throw new Error("No se pudo descargar el archivo.");const d=await a.blob(),u=window.URL.createObjectURL(d),m=document.createElement("a");m.href=u,m.download=r,document.body.appendChild(m),m.click(),m.remove(),window.URL.revokeObjectURL(u)}catch{x.show({title:"Error de descarga",message:"No se pudo descargar el archivo.",color:"red"})}},ns=()=>{i&&Q(i,!0)},Ws=()=>e.jsxs(o,{striped:!0,highlightOnHover:!0,withTableBorder:!0,children:[e.jsx(o.Thead,{children:e.jsxs(o.Tr,{children:[e.jsx(o.Th,{children:"ID"}),e.jsx(o.Th,{children:"Nombre Archivo"}),e.jsx(o.Th,{children:"Tipo"}),e.jsx(o.Th,{children:"Importado"}),e.jsx(o.Th,{children:"Registros"}),e.jsx(o.Th,{children:"Acciones"})]})}),e.jsx(o.Tbody,{children:[...Array(5)].map((s,r)=>e.jsxs(o.Tr,{children:[e.jsx(o.Td,{children:e.jsx(k,{height:20,width:30})}),e.jsx(o.Td,{children:e.jsx(k,{height:20,width:"80%"})}),e.jsx(o.Td,{children:e.jsx(k,{height:20,width:60})}),e.jsx(o.Td,{children:e.jsx(k,{height:20,width:100})}),e.jsx(o.Td,{children:e.jsx(k,{height:20,width:50})}),e.jsx(o.Td,{children:e.jsx(k,{height:20,width:80})})]},r))})]});return e.jsxs(G,{p:"md",style:{paddingLeft:32,paddingRight:32},children:[e.jsx(gr,{visible:ks&&!Ne,overlayProps:{radius:"sm",blur:2}}),e.jsx(qe,{order:2,mb:"xl",children:"Importar Datos"}),as&&T&&e.jsx(M,{color:"blue",title:"Procesando...",icon:e.jsx(he,{}),mb:"md",children:e.jsxs(C,{justify:"space-between",align:"center",children:[e.jsx(n,{size:"sm",children:as}),e.jsx(Se,{value:pe,style:{width:200},animated:!0})]})}),e.jsxs(Ge,{gutter:"xl",align:"flex-start",children:[e.jsx(Ge.Col,{span:{base:12,md:5},children:e.jsx(us,{shadow:"sm",p:"md",withBorder:!0,children:e.jsxs(oe,{gap:"lg",children:[e.jsxs(C,{align:"flex-end",justify:"space-between",mb:"md",children:[e.jsxs(G,{style:{flex:1},children:[e.jsx(de,{label:"Selecciona un Caso",placeholder:y?"Cargando casos...":"Elige el caso al que importar el archivo",data:O,value:i,onChange:s=>{H(s);const r=O.find(t=>t.value===s);E(r?r.label.split(" - ")[1].split(" (")[0]:null),w(null),N([]),R({}),D(null),J(null)},searchable:!0,nothingFoundMessage:"No se encontraron casos",disabled:y||T,error:F,required:!0,leftSection:y?e.jsx(k,{height:12,width:12}):void 0}),y&&e.jsx(n,{size:"xs",c:"dimmed",mt:4,children:"Cargando lista de casos, por favor espere..."})]}),e.jsx(j,{leftSection:e.jsx(re,{size:18}),onClick:()=>Ss(`/casos/${i}`),disabled:!i,variant:"filled",color:"#234be7",style:{minWidth:160},children:"Ir al Caso"})]}),e.jsxs(G,{children:[e.jsx(n,{size:"sm",fw:500,mb:"xs",children:"Tipo de Archivo a Importar"}),e.jsxs(C,{children:[e.jsx(j,{variant:c==="LPR"?"filled":"outline",color:"#2bd39e",onClick:()=>{W("LPR"),w(null)},disabled:T||B,leftSection:e.jsx(re,{size:18}),children:"Datos LPR"}),e.jsx(j,{variant:c==="GPS"?"filled":"outline",color:"#2bd39e",onClick:()=>{W("GPS"),w(null)},disabled:T||B,leftSection:e.jsx(re,{size:18}),children:"Datos GPS"}),e.jsx(j,{variant:c==="GPX_KML"?"filled":"outline",color:"#FF204E",onClick:()=>{W("GPX_KML"),w(null)},disabled:T||B,leftSection:e.jsx(re,{size:18}),children:"Archivo GPX/KML"})]})]}),e.jsx(jr,{label:"Archivo",placeholder:"Seleccione un archivo",leftSection:e.jsx(re,{size:we(18)}),value:h,onChange:Ks,accept:c==="GPX_KML"?".gpx,.kml":".xlsx,.xls,.csv",disabled:!i||T||B,clearable:!0}),B&&e.jsxs(M,{color:"blue",title:"Analizando archivo...",icon:e.jsx(he,{}),children:[e.jsx(n,{size:"sm",children:"Leyendo estructura del archivo y configurando mapeo automático..."}),e.jsx(Se,{value:50,mt:"sm",animated:!0})]}),e.jsxs(j,{leftSection:e.jsx(nr,{size:18}),onClick:Ie,disabled:!h||T||B,variant:"outline",mt:"xs",children:["Configurar Mapeo de Columnas",ls()&&e.jsx(ue,{color:"green",size:"xs",ml:"xs",children:"✓"})]}),Xe&&e.jsx(M,{title:"Error de Lectura",color:"red",icon:e.jsx(ae,{}),children:Xe}),e.jsx(j,{leftSection:e.jsx(he,{size:18}),onClick:$s,loading:T||ss,disabled:!i||!h||!ls()||B,mt:"lg",fullWidth:!0,children:ss?"Validando...":T?"Importando...":"Importar Archivo"}),T&&pe>0&&e.jsxs(G,{children:[e.jsxs(n,{size:"sm",mb:"xs",children:["Progreso de importación: ",pe,"%"]}),e.jsx(Se,{value:pe,animated:!0})]}),Be&&e.jsx(M,{title:"Error de Subida",color:"red",icon:e.jsx(ae,{}),children:Be}),_s]})})}),e.jsx(Ge.Col,{span:{base:12,md:7},children:i&&e.jsxs(us,{shadow:"sm",p:"md",withBorder:!0,children:[e.jsxs(C,{justify:"space-between",align:"center",mb:"md",children:[e.jsx(qe,{order:3,children:"Archivos Importados"}),e.jsxs(C,{children:[P.length>0&&e.jsxs(ue,{variant:"light",color:"blue",children:[P.length," archivo",P.length!==1?"s":""]}),e.jsx(j,{leftSection:e.jsx(ir,{size:16}),variant:"subtle",size:"sm",onClick:ns,disabled:Ae,loading:Ae,children:"Actualizar"})]})]}),Ve&&e.jsxs(M,{color:"red",title:"Error al cargar archivos",mb:"md",action:e.jsx(j,{color:"red",size:"xs",onClick:ns,children:"Reintentar"}),children:[Ve,We>0&&e.jsxs(n,{size:"xs",mt:"xs",children:["Intentos: ",We]})]}),Ae?Ws():P.length>0?e.jsxs(e.Fragment,{children:[P.length>50&&e.jsx(M,{color:"blue",icon:e.jsx(ae,{}),mb:"md",children:e.jsxs(n,{size:"sm",children:["Se encontraron ",P.length," archivos. Para mejor rendimiento, se muestran los más recientes primero."]})}),e.jsxs(o,{striped:!0,highlightOnHover:!0,withTableBorder:!0,children:[e.jsx(o.Thead,{children:e.jsxs(o.Tr,{children:[e.jsx(o.Th,{children:"ID"}),e.jsx(o.Th,{children:"Nombre Archivo"}),e.jsx(o.Th,{children:"Tipo"}),e.jsx(o.Th,{children:"Importado"}),e.jsx(o.Th,{children:"Registros"}),e.jsx(o.Th,{children:"Acciones"})]})}),e.jsx(o.Tbody,{children:P.sort((s,r)=>new Date(r.Fecha_de_Importacion).getTime()-new Date(s.Fecha_de_Importacion).getTime()).slice(0,100).map(s=>e.jsxs(o.Tr,{children:[e.jsx(o.Td,{children:s.ID_Archivo}),e.jsx(o.Td,{style:{maxWidth:"500px",wordBreak:"break-word"},children:e.jsx(n,{style:{whiteSpace:"normal",lineHeight:1.3},children:s.Nombre_del_Archivo})}),e.jsx(o.Td,{children:e.jsx(ue,{variant:"light",color:s.Tipo_de_Archivo==="LPR"?"green":s.Tipo_de_Archivo==="GPS"?"blue":"orange",children:s.Tipo_de_Archivo})}),e.jsx(o.Td,{children:new Date(s.Fecha_de_Importacion).toLocaleString("es-ES",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"})}),e.jsx(o.Td,{children:e.jsx(ue,{variant:"outline",color:"gray",children:s.Total_Registros.toLocaleString()})}),e.jsx(o.Td,{children:e.jsxs(C,{gap:4,children:[e.jsx(vs,{label:"Descargar",withinPortal:!0,children:e.jsx(ms,{variant:"subtle",color:"blue",onClick:()=>Us(s.ID_Archivo,s.Nombre_del_Archivo),children:e.jsx(fr,{size:16})})}),e.jsx(vs,{label:"Eliminar",withinPortal:!0,children:e.jsx(ms,{variant:"subtle",color:"red",onClick:()=>Bs(s.ID_Archivo),loading:Ke===s.ID_Archivo,children:e.jsx(cr,{size:16})})})]})})]},s.ID_Archivo))})]}),P.length>100&&e.jsxs(n,{size:"sm",c:"dimmed",mt:"sm",ta:"center",children:["Mostrando los 100 archivos más recientes de ",P.length," total. Para ver todos los archivos, use la página de gestión del caso."]})]}):e.jsx(dr,{p:"xl",children:e.jsxs(oe,{align:"center",gap:"sm",children:[e.jsx(re,{size:48,color:"#ccc"}),e.jsx(n,{c:"dimmed",children:"No hay archivos importados para este caso"}),e.jsx(n,{size:"sm",c:"dimmed",children:"Los archivos aparecerán aquí después de importarlos"})]})})]})})]}),e.jsx(Ee,{opened:Te,onClose:Me,title:"Configurar Mapeo de Columnas",size:"lg",children:e.jsxs(oe,{children:[e.jsx(n,{size:"sm",c:"dimmed",children:"Selecciona qué columna del archivo Excel corresponde a cada campo requerido."}),e.jsx(Oe,{my:"sm"}),e.jsx(bs,{cols:2,children:U[c].map(s=>ie&&(s==="Hora"||s==="Fecha")?s==="Hora"?null:e.jsx(de,{label:"Fecha y Hora",placeholder:"Selecciona columna para Fecha y Hora",data:le,value:X[s]||void 0,onChange:r=>{ve("Fecha",r),ve("Hora",r)},required:!0},s):e.jsx(de,{label:s,placeholder:`Selecciona columna para ${s}`,data:le,value:X[s]||void 0,onChange:r=>ve(s,r),required:!0},s))}),e.jsx(Oe,{my:"sm"}),e.jsx(n,{size:"sm",fw:500,children:"Campos Opcionales"}),e.jsx(n,{size:"xs",c:"dimmed",mb:"md",children:"Estos campos no son obligatorios, pero si están disponibles en tu archivo, puedes mapearlos."}),e.jsx(bs,{cols:2,children:ye[c].map(s=>e.jsx(de,{label:s,placeholder:`Selecciona columna para ${s}`,data:le,value:X[s]||void 0,onChange:r=>ve(s,r),clearable:!0},s))}),e.jsx(Oe,{my:"sm"}),e.jsx(vr,{label:"La fecha y hora vienen en una sola columna",checked:ie,onChange:s=>Is(s.currentTarget.checked)}),ie&&e.jsx(de,{label:"Formato de fecha y hora",placeholder:"Selecciona el formato",value:Ye,onChange:s=>Ms(s||"DD/MM/YYYY HH:mm:ss"),data:[{value:"DD/MM/YYYY HH:mm:ss",label:"DD/MM/YYYY HH:mm:ss"},{value:"YYYY-MM-DD HH:mm:ss",label:"YYYY-MM-DD HH:mm:ss"},{value:"DD-MM-YYYY HH:mm:ss",label:"DD-MM-YYYY HH:mm:ss"},{value:"MM/DD/YYYY HH:mm:ss",label:"MM/DD/YYYY HH:mm:ss"},{value:"YYYY/MM/DD HH:mm:ss",label:"YYYY/MM/DD HH:mm:ss"}]}),e.jsxs(C,{justify:"flex-end",mt:"md",children:[e.jsx(j,{variant:"outline",onClick:Me,children:"Cancelar"}),e.jsx(j,{onClick:Ns,children:"Guardar Mapeo"})]})]})}),e.jsx(Ee,{opened:ys,onClose:()=>{Le(),me(!1),V(!1)},title:"Especificar Matrícula",size:"md",children:e.jsxs(oe,{children:[e.jsx(n,{size:"sm",c:"dimmed",children:"Para procesar correctamente los datos GPX/KML, necesitamos asignar una matrícula a los puntos."}),e.jsx(hr,{label:"Matrícula",placeholder:"Ingresa la matrícula del vehículo",value:ke,onChange:s=>Ze(s.target.value),required:!0}),e.jsxs(C,{justify:"flex-end",mt:"md",children:[e.jsx(j,{variant:"outline",onClick:()=>{Le(),me(!1),V(!1)},children:"Cancelar"}),e.jsx(j,{onClick:async()=>{if(!ke){x.show({title:"Matrícula Requerida",message:"Debes especificar una matrícula para continuar.",color:"red"});return}Le(),setTimeout(()=>{be()},0)},children:"Continuar"})]})]})}),e.jsx(Ee,{opened:Ts,onClose:()=>{ge(!1),je(null)},title:"Confirmar Eliminación",size:"md",centered:!0,children:e.jsxs(oe,{children:[e.jsxs(n,{size:"md",children:["¿Estás seguro de que quieres eliminar el archivo ",e.jsx("b",{children:v==null?void 0:v.Nombre_del_Archivo})," (ID ",v==null?void 0:v.ID_Archivo,") y todas sus lecturas asociadas?"]}),e.jsx(n,{size:"sm",c:"red.7",children:"Esta acción no se puede deshacer."}),e.jsxs(C,{justify:"flex-end",mt:"md",children:[e.jsx(j,{variant:"outline",onClick:()=>{ge(!1),je(null)},children:"Cancelar"}),e.jsx(j,{color:"red",onClick:Vs,loading:Ke===(v==null?void 0:v.ID_Archivo),children:"Eliminar"})]})]})}),e.jsx(Sr,{opened:Ps,onClose:Xs,onConfirm:qs,validacionData:Ls,loading:T})]})}export{Nr as default};
