(function(){"use strict";const u=(e,n,t,s)=>{const a=(t-e)*Math.PI/180,o=(s-n)*Math.PI/180,d=Math.sin(a/2)*Math.sin(a/2)+Math.cos(e*Math.PI/180)*Math.cos(t*Math.PI/180)*Math.sin(o/2)*Math.sin(o/2);return 6371*(2*Math.atan2(Math.sqrt(d),Math.sqrt(1-d)))},g=(e,n=1e-4)=>{const t=[],s=new Set;return e.forEach((c,a)=>{if(s.has(a))return;const o=[c];s.add(a),e.forEach((d,r)=>{if(a===r||s.has(r))return;u(c.Coordenada_Y,c.Coordenada_X,d.Coordenada_Y,d.Coordenada_X)<n&&(o.push(d),s.add(r))}),t.push(o)}),t},C=e=>{const n=e.reduce((s,c)=>s+c.Coordenada_Y,0),t=e.reduce((s,c)=>s+c.Coordenada_X,0);return{...e[0],Coordenada_Y:n/e.length,Coordenada_X:t/e.length,clusterSize:e.length}},M=(e,n={minDistance:.05,maxAngle:30,keepStops:!0,keepSpeedChanges:!0,speedThreshold:10})=>{if(e.length<=2)return e;const t=[e[0]];let s=e[0],c=!1;for(let a=1;a<e.length-1;a++){const o=e[a],d=e[a+1],r=u(s.Coordenada_Y,s.Coordenada_X,o.Coordenada_Y,o.Coordenada_X),l=a>0&&a<e.length-1?_(e[a-1],o,d):0,i=(o.Velocidad||0)>5;l<n.maxAngle&&i?c=!0:c=!1;const f=o.duracion_parada_min&&o.duracion_parada_min>0,m=Math.abs((o.Velocidad||0)-(s.Velocidad||0))>n.speedThreshold,L=c?.1:n.minDistance;(n.keepStops&&f||n.keepSpeedChanges&&m||r>L||a>0&&a<e.length-1&&l>n.maxAngle)&&(t.push(o),s=o)}return e.length>1&&t.push(e[e.length-1]),t},_=(e,n,t)=>{const s=e.Coordenada_Y,c=e.Coordenada_X,a=n.Coordenada_Y,o=n.Coordenada_X,d=t.Coordenada_Y,r=t.Coordenada_X,l=Math.atan2(o-c,a-s),i=Math.atan2(r-o,d-a);let h=Math.abs(l-i)*180/Math.PI;return h>180?360-h:h};self.addEventListener("message",e=>{const{type:n,data:t}=e.data;switch(n){case"cluster":const c=g(t.points,t.maxDistance).map(C);self.postMessage({type:"cluster",data:c});break;case"decimate":const a=M(t.points,t.options);self.postMessage({type:"decimate",data:a});break;default:console.warn("Unknown message type:",n)}})})();
