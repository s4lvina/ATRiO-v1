import{c as ee,f as W,u as Y,a as se,j as e,B as w,g as H,b as Q,d as te,r as i,e as re,h as ae,i as X,k as oe,l as L,P as y,S,G as f,T as ie,m as U,n as h,I as ne,o as Z,p as le,q as $,s as ce,L as M,A as J,t as de,v as P,w as me,x as ue,y as he,z as A}from"./index-B9r5cl9W.js";import{g as pe}from"./casosApi-BKSmOZmE.js";import{u as xe}from"./FileSaver.min-Bz-SbG9W.js";import{B as z}from"./Badge-0g_QzpBM.js";import{D as ge}from"./Divider-tgUTFFpg.js";import{g as fe,a as je,L as B,M as be,T as we,b as ye}from"./leaflet-Cfx-CTIt.js";import{B as Ce}from"./BusquedaMulticasoPanel-C7B9PGYM.js";import{G as R}from"./Grid-yhenIOJ3.js";import{C as ve}from"./Card-CcdvnKuo.js";import{S as _e}from"./SimpleGrid-D2l_HKT_.js";import{I as Se}from"./IconDatabase-DfjV116Y.js";import{I as ze}from"./IconSearch-DHaK-uKX.js";import{T as Ie}from"./ThemeIcon-CWZr28Bc.js";import"./xlsx-CwpDMyS9.js";import"./MultiSelect-MjVHzexh.js";import"./Pagination-vgEYL1ab.js";const[De,Te]=ee("Timeline component was not found in tree");var O={root:"m_43657ece",itemTitle:"m_2ebe8099",item:"m_436178ff",itemBullet:"m_8affcee1",itemBody:"m_540e8f41"};const Ee={},q=W((t,r)=>{const a=Y("TimelineItem",Ee,t),{classNames:n,className:p,style:u,styles:m,vars:g,__active:l,__align:x,__lineActive:j,__vars:C,bullet:o,radius:s,color:c,lineVariant:d,children:b,title:T,mod:F,...N}=a,v=Te(),I=se(),_={classNames:n,styles:m};return e.jsxs(w,{...v.getStyles("item",{..._,className:p,style:u}),mod:[{"line-active":j,active:l},F],ref:r,__vars:{"--tli-radius":s?Q(s):void 0,"--tli-color":c?H(c,I):void 0,"--tli-border-style":d||void 0},...N,children:[e.jsx(w,{...v.getStyles("itemBullet",_),mod:{"with-child":!!o,align:x,active:l},children:o}),e.jsxs("div",{...v.getStyles("itemBody",_),children:[T&&e.jsx("div",{...v.getStyles("itemTitle",_),children:T}),e.jsx("div",{...v.getStyles("itemContent",_),children:b})]})]})});q.classes=O;q.displayName="@mantine/core/TimelineItem";const Le={active:-1,align:"left",reverseActive:!1},Be=re((t,{bulletSize:r,lineWidth:a,radius:n,color:p,autoContrast:u})=>({root:{"--tl-bullet-size":X(r),"--tl-line-width":X(a),"--tl-radius":n===void 0?void 0:Q(n),"--tl-color":p?H(p,t):void 0,"--tl-icon-color":oe(u,t)?ae({color:p,theme:t,autoContrast:u}):void 0}})),D=W((t,r)=>{const a=Y("Timeline",Le,t),{classNames:n,className:p,style:u,styles:m,unstyled:g,vars:l,children:x,active:j,color:C,radius:o,bulletSize:s,align:c,lineWidth:d,reverseActive:b,mod:T,autoContrast:F,...N}=a,v=te({name:"Timeline",classes:O,props:a,className:p,style:u,classNames:n,styles:m,unstyled:g,vars:l,varsResolver:Be}),I=i.Children.toArray(x),_=I.map((k,E)=>{var V,G;return i.cloneElement(k,{unstyled:g,__align:c,__active:((V=k.props)==null?void 0:V.active)||(b?j>=I.length-E-1:j>=E),__lineActive:((G=k.props)==null?void 0:G.lineActive)||(b?j>=I.length-E-1:j-1>=E)})});return e.jsx(De,{value:{getStyles:v},children:e.jsx(w,{...v("root"),mod:[{align:c},T],ref:r,...N,children:_})})});D.classes=O;D.displayName="@mantine/core/Timeline";D.Item=q;const Ne=async()=>{try{return(await L.get("/api/estadisticas")).data}catch(t){throw console.error("Error al obtener estadísticas globales:",t),t}},K=async t=>{try{const r=t.trim().toUpperCase(),n=(await L.get("/casos")).data.map(l=>l.ID_Caso);if(!n||n.length===0)return{matricula:r,lecturas:[]};const u=(await L.post("/busqueda/multicaso",{casos:n,matricula:r})).data;if(!u||u.length===0)return{matricula:r,lecturas:[]};const m=u.find(l=>l.matricula.toUpperCase()===r);if(!m)return{matricula:r,lecturas:[]};const g=m.casos.flatMap(l=>l.lecturas.map(x=>({id:x.ID_Lectura,fecha:new Date(x.Fecha_y_Hora).toLocaleString("es-ES"),lector:x.ID_Lector,caso:x.Nombre_del_Caso||`Caso ${x.ID_Caso}`})));return{matricula:r,lecturas:g}}catch(r){throw console.error("Error al buscar vehículo:",r),new Error("No se pudo realizar la búsqueda del vehículo. Por favor, intenta de nuevo.")}},ke=async()=>{try{return(await L.get("/api/archivos/recientes")).data.map(r=>{var a;return{id:r.ID_Archivo,fileName:r.Nombre_del_Archivo,timestamp:r.Fecha_de_Importacion,status:"success",recordsCount:r.Total_Registros,caseName:((a=r.caso)==null?void 0:a.Nombre_del_Caso)||`Caso ${r.ID_Caso}`}})}catch(t){throw console.error("Error al obtener importaciones recientes:",t),t}};function Ae({onSearch:t}){const[r,a]=i.useState(""),[n]=xe(r,500),[p,u]=i.useState(!1),[m,g]=i.useState(null),[l,x]=i.useState(null),j=i.useCallback(async()=>{if(n.trim()){u(!0),g(null),x(null);try{const o=await K(n);x(o),t(n)}catch(o){g(o.message||"Error al buscar el vehículo")}finally{u(!1)}}},[n,t]),C=i.useMemo(()=>{if(!l)return[];const o={};return l.lecturas.forEach(s=>{const c=s.caso||"SIN CASO";o[c]||(o[c]=[]),o[c].push(s)}),Object.values(o).forEach(s=>s.sort((c,d)=>new Date(d.fecha).getTime()-new Date(c.fecha).getTime())),Object.entries(o).sort(([,s],[,c])=>new Date(c[0].fecha).getTime()-new Date(s[0].fecha).getTime()).slice(0,5)},[l]);return e.jsx(y,{p:"md",withBorder:!0,shadow:"md",radius:"md",style:{width:"100%"},children:e.jsxs(S,{children:[e.jsxs(f,{children:[e.jsx(ie,{placeholder:"Introduce una matrícula...",value:r,onChange:o=>a(o.target.value),style:{flex:1}}),e.jsx(U,{onClick:j,loading:p,children:"Buscar"}),e.jsx(U,{variant:"light",color:"gray",onClick:()=>{a(""),x(null),g(null)},disabled:p,children:"Limpiar"})]}),m&&e.jsx(h,{c:"red",size:"sm",children:m}),l&&e.jsx(y,{p:"md",withBorder:!0,children:e.jsxs(S,{children:[e.jsxs(f,{children:[e.jsxs(h,{fw:500,size:"lg",children:["Matrícula: ",l.matricula]}),e.jsxs(z,{size:"lg",variant:"light",children:[l.lecturas.length," lecturas"]})]}),l.lecturas.length===0?e.jsx(h,{c:"dimmed",children:"No se encontraron lecturas para esta matrícula"}):e.jsxs(e.Fragment,{children:[e.jsxs(S,{children:[e.jsxs(f,{children:[e.jsx(ne,{size:16}),e.jsx(h,{fw:500,children:"Casos encontrados:"})]}),e.jsxs(f,{children:[C.map(([o,s])=>e.jsxs(z,{size:"md",variant:"filled",children:[o," (",s.length,")"]},o)),l.lecturas.length>5&&e.jsxs(z,{size:"md",variant:"light",children:["+",l.lecturas.length-5," más"]})]})]}),e.jsx(ge,{}),e.jsxs(S,{children:[e.jsx(h,{fw:500,children:"Últimas lecturas:"}),l.lecturas.sort((o,s)=>new Date(s.fecha).getTime()-new Date(o.fecha).getTime()).slice(0,5).map(o=>e.jsxs(f,{justify:"space-between",children:[e.jsxs(S,{gap:0,children:[e.jsx(h,{size:"sm",fw:500,children:o.lector}),e.jsx(h,{size:"xs",c:"dimmed",children:new Date(o.fecha).toLocaleString()})]}),e.jsx(z,{size:"sm",variant:"light",children:o.caso||"SIN CASO"})]},o.id))]})]})]})})]})})}function Re(t){if(/^\d{4}-\d{2}-\d{2}$/.test(t)){const[a,n,p]=t.split("-");return`${p}/${n}/${a}`}const r=new Date(t);return isNaN(r.getTime())?t:r.toLocaleString("es-ES",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"})}function $e({events:t}){const r=[...t].sort((a,n)=>new Date(n.timestamp).getTime()-new Date(a.timestamp).getTime());return e.jsxs(y,{shadow:"sm",p:"md",withBorder:!0,children:[e.jsx(h,{size:"lg",fw:500,mb:"md",children:"Últimas Importaciones"}),e.jsx(D,{active:r.length-1,bulletSize:24,lineWidth:2,children:r.map(a=>e.jsx(D.Item,{bullet:a.status==="success"?e.jsx(ce,{size:16,color:"#2ecc40"}):e.jsx($,{size:16,color:"#e03131"}),title:e.jsxs(f,{children:[e.jsx(h,{size:"sm",fw:500,children:a.fileName}),e.jsx(z,{color:a.status==="success"?"green":"red",variant:"light",size:"sm",children:a.status==="success"?e.jsxs(f,{gap:4,children:[e.jsx(le,{size:12}),typeof a.recordsCount=="number"?`${a.recordsCount} registros`:"0 registros"]}):e.jsxs(f,{gap:4,children:[e.jsx($,{size:12})," Error"]})})]}),children:e.jsxs(w,{children:[e.jsx(h,{size:"xs",c:"dimmed",mt:4,children:Re(a.timestamp)}),a.caseName&&e.jsxs(f,{gap:4,mt:4,children:[e.jsx(Z,{size:12,color:"#234be7"}),e.jsx(h,{size:"xs",c:"blue.7",children:a.caseName})]})]})},a.id))})]})}function Pe(){const[t,r]=i.useState(null),[a,n]=i.useState(!0),[p,u]=i.useState(null);return i.useEffect(()=>{(async()=>{n(!0),u(null);try{const{total_count:g}=await fe();r(g)}catch{u("No se pudo obtener la información de los lectores.")}finally{n(!1)}})()},[]),a?e.jsx(y,{shadow:"sm",p:"md",withBorder:!0,mb:"md",mt:"md",children:e.jsx(M,{size:"sm"})}):p?e.jsx(y,{shadow:"sm",p:"md",withBorder:!0,mb:"md",mt:"md",children:e.jsx(J,{color:"red",children:p})}):e.jsxs(y,{shadow:"sm",p:"md",withBorder:!0,mb:"md",mt:"md",children:[e.jsxs(f,{justify:"space-between",mb:"xs",children:[e.jsxs(f,{children:[e.jsx(de,{color:"#2ecc40",size:20}),e.jsx(h,{fw:500,size:"sm",children:"Total de lectores en el sistema"})]}),e.jsx(z,{color:"green",variant:"light",children:t})]}),e.jsx(h,{size:"xs",children:"Este es el número total de lectores actualmente registrados en el sistema."})]})}delete B.Icon.Default.prototype._getIconUrl;B.Icon.Default.mergeOptions({iconRetinaUrl:"https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon-2x.png",iconUrl:"https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon.png",shadowUrl:"https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png"});function Me(){var C,o;const[t,r]=i.useState([]),[a,n]=i.useState(!0),[p,u]=i.useState(null),[m,g]=i.useState(null),l=i.useRef(null),x=i.useCallback(async()=>{n(!0),u(null);try{const s=await je();r(s||[])}catch(s){u("Error al cargar los lectores."),console.error(s)}finally{n(!1)}},[]);i.useEffect(()=>{x()},[x]);const j=t.filter(s=>s.Coordenada_X!=null&&s.Coordenada_Y!=null&&s.Coordenada_X!==0&&s.Coordenada_Y!==0);return i.useEffect(()=>{if(l.current&&j.length>0){const s=B.latLngBounds(j.map(c=>[c.Coordenada_Y,c.Coordenada_X]));l.current.fitBounds(s,{padding:[40,40]})}},[j]),a?e.jsx(y,{shadow:"sm",p:"md",withBorder:!0,style:{height:"640px",display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx(M,{size:"lg"})}):p?e.jsx(y,{shadow:"sm",p:"md",withBorder:!0,style:{height:"640px",display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx(J,{color:"red",title:"Error",children:p})}):e.jsxs(y,{shadow:"sm",p:"md",withBorder:!0,children:[e.jsx(P,{order:3,mb:"md",children:"Mapa de Lectores"}),e.jsxs(w,{style:{height:"640px",width:"100%",position:"relative"},children:[m&&e.jsx(w,{style:{position:"absolute",bottom:20,left:"50%",transform:"translateX(-50%)",zIndex:1e3,backgroundColor:"white",padding:"15px 20px",borderRadius:"8px",boxShadow:"0 2px 10px rgba(0,0,0,0.1)",maxWidth:"90%",width:"auto"},children:e.jsxs(S,{gap:"xs",children:[e.jsxs(f,{gap:"xs",align:"center",children:[e.jsx(w,{style:{width:"12px",height:"12px",borderRadius:"50%",backgroundColor:m.markerColor||"#011638",flexShrink:0}}),e.jsxs(h,{fw:700,size:"sm",children:[m.ID_Lector,m.Nombre&&` - ${m.Nombre}`]}),e.jsx(me,{variant:"subtle",color:"gray",onClick:()=>g(null),size:"sm",style:{marginLeft:"auto"},children:e.jsx($,{size:14})})]}),e.jsxs(f,{gap:"md",children:[e.jsxs(h,{size:"sm",children:[e.jsx("b",{children:"Carretera:"})," ",m.Carretera||"-"]}),e.jsxs(h,{size:"sm",children:[e.jsx("b",{children:"Provincia:"})," ",m.Provincia||"-"]})]}),e.jsxs(f,{gap:"md",children:[e.jsxs(h,{size:"sm",children:[e.jsx("b",{children:"Sentido:"})," ",m.Sentido||"-"]}),e.jsxs(h,{size:"sm",children:[e.jsx("b",{children:"Organismo:"})," ",m.Organismo_Regulador||"-"]})]}),e.jsx(f,{gap:"md",children:e.jsxs(h,{size:"sm",children:[e.jsx("b",{children:"Coordenadas:"})," ",(C=m.Coordenada_Y)==null?void 0:C.toFixed(6),", ",(o=m.Coordenada_X)==null?void 0:o.toFixed(6)]})})]})}),j.length>0?e.jsxs(be,{center:[40.4168,-3.7038],zoom:11,scrollWheelZoom:!0,style:{height:"100%",width:"100%"},ref:l,children:[e.jsx(we,{url:"https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",attribution:'© <a href="https://carto.com/attributions">CARTO</a>'}),j.map(s=>{const c=m&&m.ID_Lector===s.ID_Lector,d=B.divIcon({html:`<span style="
                  background-color: ${s.Sentido==="Creciente"?"#ff0f35":s.Sentido==="Decreciente"?"#00a9d4":"#011638"}; 
                  width: ${c?"30px":"20px"}; 
                  height: ${c?"30px":"20px"}; 
                  border-radius: 50%; 
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  border: ${c?"3px solid #222":"2px solid white"}; 
                  box-shadow: ${c?"0 0 0 4px rgba(1,22,56,0.15)":"0 0 4px rgba(0,0,0,0.4)"};
                  font-weight: bold;
                  font-size: ${c?"14px":"12px"};
                  color: ${s.Sentido==="Creciente"?"white":s.Sentido==="Decreciente"?"#1c0021":"transparent"};
                ">${s.Sentido==="Creciente"?"C":s.Sentido==="Decreciente"?"D":""}</span>`,className:"custom-div-icon",iconSize:c?[30,30]:[20,20],iconAnchor:c?[15,15]:[10,10]});return e.jsx(ye,{position:[s.Coordenada_Y,s.Coordenada_X],icon:d,eventHandlers:{click:()=>{g({...s,lecturas:[],markerColor:s.Sentido==="Creciente"?"#ff0f35":s.Sentido==="Decreciente"?"#00a9d4":"#011638"})}}},s.ID_Lector)})]}):e.jsx(h,{children:"No hay lectores con coordenadas para mostrar en el mapa."})]})]})}const Oe=[{title:"Base de Datos",value:"2.5 TB",color:"blue",icon:Se},{title:"Casos Activos",value:"15",color:"green",icon:Z},{title:"Lecturas Totales",value:"1,234,567",color:"violet",icon:he},{title:"Vehículos Registrados",value:"89,123",color:"orange",icon:ze}];function qe(){const[t,r]=i.useState(null),[a,n]=i.useState(!0),[p,u]=i.useState(null),[m,g]=i.useState([]),[l,x]=i.useState([]),[j,C]=i.useState({files:!0,imports:!0});ue();const o=i.useCallback(async()=>{n(!0),u(null);try{const d=await Ne();r(d)}catch(d){u(d.message||"Error al cargar las estadísticas."),r(null)}finally{n(!1)}},[]),s=i.useCallback(async()=>{try{const[d,b]=await Promise.all([pe(),ke()]);g(d),x(b)}catch(d){console.error("Error al cargar datos del dashboard:",d)}finally{C({files:!1,imports:!1})}},[]);i.useEffect(()=>{o(),s()},[o,s]);const c=async d=>{try{const b=await K(d);b&&b.lecturas.length>0?A.show({title:"Vehículo encontrado",message:`Se encontraron ${b.lecturas.length} lecturas para la matrícula ${d}`,color:"green"}):A.show({title:"Vehículo no encontrado",message:`No se encontraron lecturas para la matrícula ${d}`,color:"yellow"})}catch{A.show({title:"Error en la búsqueda",message:"No se pudo realizar la búsqueda del vehículo",color:"red"})}};return e.jsx(w,{style:{padding:"20px 32px"},children:e.jsxs(R,{children:[e.jsxs(R.Col,{span:{base:12,md:8},children:[e.jsx(P,{order:3,mt:"md",mb:"xs",children:"Búsqueda Rápida"}),e.jsx(Ae,{onSearch:c}),e.jsx(P,{order:3,mt:"md",mb:"xs",children:"Búsqueda Multi-Caso"}),e.jsx(ve,{shadow:"sm",radius:"md",padding:"lg",withBorder:!0,mt:0,children:e.jsx(Ce,{})}),e.jsx(w,{mt:"xl",children:e.jsx(Me,{})})]}),e.jsxs(R.Col,{span:{base:12,md:4},children:[e.jsx(_e,{cols:2,spacing:"lg",children:Oe.map(d=>e.jsx(y,{p:"lg",withBorder:!0,children:e.jsxs(f,{children:[e.jsx(Ie,{size:"xl",color:d.color,variant:"light",children:e.jsx(d.icon,{size:24})}),e.jsxs("div",{children:[e.jsx(h,{size:"sm",c:"dimmed",children:d.title}),e.jsx(h,{fw:500,size:"xl",children:a?e.jsx(M,{size:"xs"}):t?d.title==="Base de Datos"?t.tamanio_bd:d.title==="Casos Activos"?t.total_casos:d.title==="Lecturas Totales"?t.total_lecturas:t.total_vehiculos:"-"})]})]})},d.title))}),e.jsx(Pe,{}),e.jsx(w,{mt:"xl",children:e.jsx($e,{events:l.slice(0,6)})})]})]})})}function as(t){return e.jsx(qe,{...t})}export{as as default};
