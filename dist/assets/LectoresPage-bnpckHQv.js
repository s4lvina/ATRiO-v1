import{M as Ga,r as t,j as e,W as we,T as ie,ai as ne,G as w,m as I,L as ca,B as A,v as J,n as R,$ as Xa,A as Te,t as ke,z as E,S as Se,N as fe,Y as Ya,U as aa,w as ve,q as da,p as Oe,P as Ne,X as Wa}from"./index-B9r5cl9W.js";import{h as ua,u as pa,g as ra,a as Ha,L as V,M as Ja,T as Va,b as Za,i as oa,j as Ka}from"./leaflet-Cfx-CTIt.js";import{L as Me}from"./LoadingOverlay-CxXc0-rV.js";import{S as Ee}from"./SimpleGrid-D2l_HKT_.js";import{S as ee,a as L,T as ta}from"./Table-D9CHl7vx.js";import{T as Qa,I as sa}from"./IconPlus-Bn3VW0f2.js";import{u as er,C as te,D as ha}from"./Divider-tgUTFFpg.js";import{r as la,u as Le,a as ar}from"./xlsx-CwpDMyS9.js";import{F as rr,I as ma}from"./IconUpload-C-eXztvs.js";import{I as or}from"./IconInfoCircle-CeWkeBUc.js";import{C as tr}from"./Card-CcdvnKuo.js";import{q as sr}from"./index-CYMPojJR.js";import{I as ga,p as lr,t as nr,c as ir,A as xa,D as cr,a as dr,d as ur,h as pr,C as hr}from"./index-DptuRD17.js";import{M as B}from"./MultiSelect-MjVHzexh.js";import{I as Ae,S as mr}from"./IconEdit-OjoKMjxd.js";import{C as na}from"./Checkbox-B2UTVamD.js";import"./Pagination-vgEYL1ab.js";/**
 * @license @tabler/icons-react v3.34.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var gr=Ga("outline","list","IconList",[["path",{d:"M9 6l11 0",key:"svg-0"}],["path",{d:"M9 12l11 0",key:"svg-1"}],["path",{d:"M9 18l11 0",key:"svg-2"}],["path",{d:"M5 6l0 .01",key:"svg-3"}],["path",{d:"M5 12l0 .01",key:"svg-4"}],["path",{d:"M5 18l0 .01",key:"svg-5"}]]);const xr=[{value:"N",label:"Norte (N)"},{value:"NE",label:"Noreste (NE)"},{value:"E",label:"Este (E)"},{value:"SE",label:"Sureste (SE)"},{value:"S",label:"Sur (S)"},{value:"SO",label:"Suroeste (SO)"},{value:"O",label:"Oeste (O)"},{value:"NO",label:"Noroeste (NO)"}],br=[{value:"Creciente",label:"Creciente"},{value:"Decreciente",label:"Decreciente"}];function Ce({placeholder:h,value:g,onChange:n,data:k,loading:u,disabled:y}){const i=er({}),[j,s]=t.useState(g||"");t.useEffect(()=>{s(g||"")},[g]);const p=k.filter(c=>c.toLowerCase().includes(j.toLowerCase().trim())).map(c=>e.jsx(te.Option,{value:c,children:c},c));return e.jsxs(te,{store:i,withinPortal:!1,onOptionSubmit:c=>{n(c),s(c),i.closeDropdown()},disabled:y,children:[e.jsx(te.Target,{children:e.jsx(ne,{placeholder:h,value:j,onChange:c=>{s(c.currentTarget.value),n(c.currentTarget.value),i.openDropdown(),i.updateSelectedOptionIndex()},onClick:()=>i.openDropdown(),onFocus:()=>i.openDropdown(),onBlur:()=>{setTimeout(()=>i.closeDropdown(),150)},rightSection:u?e.jsx(ca,{size:"xs"}):null,disabled:y})}),e.jsx(te.Dropdown,{children:e.jsxs(te.Options,{children:[u&&e.jsx(te.Empty,{children:"Cargando..."}),!u&&p.length===0&&e.jsx(te.Empty,{children:"No hay sugerencias. Escribe para añadir."}),p]})})]})}const jr=({opened:h,onClose:g,lector:n,onSave:k})=>{const[u,y]=t.useState({}),[i,j]=t.useState(!1),[s,v]=t.useState(null),[p,c]=t.useState(!1);t.useEffect(()=>{h&&!s&&!p&&(c(!0),console.log("[EditModal] Abierto y sin sugerencias, llamando a getLectorSugerencias..."),ua().then(l=>{console.log("[EditModal] Sugerencias recibidas de API:",l),v(l)}).catch(l=>{console.error("[EditModal] Error cargando sugerencias:",l),v({provincias:[],localidades:[],carreteras:[],organismos:[],contactos:[]})}).finally(()=>c(!1)))},[h,s,p]),console.log("[EditModal] Renderizando. Estado sugerencias:",s),t.useEffect(()=>{y(n?{Nombre:n.Nombre||n.ID_Lector,Carretera:n.Carretera||"",Provincia:n.Provincia||"",Localidad:n.Localidad||"",Sentido:n.Sentido||"",Orientacion:n.Orientacion||null,Organismo_Regulador:n.Organismo_Regulador||"",Contacto:n.Contacto||"",UbicacionInput:n.Coordenada_Y!=null&&n.Coordenada_X!=null?`${n.Coordenada_Y}, ${n.Coordenada_X}`:"",Texto_Libre:n.Texto_Libre||"",Imagen_Path:n.Imagen_Path||""}:{})},[n]);const f=(l,X)=>{y(z=>({...z,[l]:X}))},G=async()=>{var l;if(n){j(!0);try{const X={...u,Orientacion:u.Orientacion||null,UbicacionInput:((l=u.UbicacionInput)==null?void 0:l.trim())||null};await k(n.ID_Lector,X)}catch(X){console.error("Error guardando lector desde modal:",X)}finally{j(!1)}}},x=()=>{j(!1),g()};return console.log("[EditModal] Renderizando."),console.log("  Estado sugerencias:",s),console.log("  Datos para Combobox Carretera:",(s==null?void 0:s.carreteras)||[]),console.log("  Datos para Combobox Provincia:",(s==null?void 0:s.provincias)||[]),console.log("  Datos para Combobox Localidad:",(s==null?void 0:s.localidades)||[]),console.log("  Datos para Combobox Organismo:",(s==null?void 0:s.organismos)||[]),console.log("  Datos para Combobox Contacto:",(s==null?void 0:s.contactos)||[]),e.jsxs(we,{opened:h,onClose:x,title:`Editar Lector: ${(n==null?void 0:n.ID_Lector)||""}`,size:"xl",overlayProps:{backgroundOpacity:.55,blur:3},children:[e.jsx(Me,{visible:i||p,overlayProps:{blur:2}}),e.jsxs(Ee,{cols:2,spacing:"md",children:[e.jsx(ie,{label:"Nombre",placeholder:"Nombre descriptivo del lector",value:u.Nombre||"",onChange:l=>f("Nombre",l.currentTarget.value),disabled:i}),e.jsx(ne.Wrapper,{label:"Carretera / Vía",children:e.jsx(Ce,{placeholder:"Ej: A-4, M-30...",value:u.Carretera||null,onChange:l=>f("Carretera",l),data:(s==null?void 0:s.carreteras)||[],loading:p,disabled:i})}),e.jsx(ne.Wrapper,{label:"Provincia",children:e.jsx(Ce,{placeholder:"Ej: Madrid...",value:u.Provincia||null,onChange:l=>f("Provincia",l),data:(s==null?void 0:s.provincias)||[],loading:p,disabled:i})}),e.jsx(ne.Wrapper,{label:"Localidad",children:e.jsx(Ce,{placeholder:"Ej: Getafe...",value:u.Localidad||null,onChange:l=>f("Localidad",l),data:(s==null?void 0:s.localidades)||[],loading:p,disabled:i})}),e.jsx(ee,{label:"Sentido",placeholder:"Selecciona el sentido",value:u.Sentido||null,onChange:l=>f("Sentido",l),data:br,clearable:!0,disabled:i}),e.jsx(ee,{label:"Orientación",placeholder:"Selecciona la orientación",value:u.Orientacion||null,onChange:l=>f("Orientacion",l),data:xr,clearable:!0,disabled:i}),e.jsx(ne.Wrapper,{label:"Organismo Regulador",children:e.jsx(Ce,{placeholder:"Ej: DGT, Ayuntamiento...",value:u.Organismo_Regulador||null,onChange:l=>f("Organismo_Regulador",l),data:(s==null?void 0:s.organismos)||[],loading:p,disabled:i})}),e.jsx(ne.Wrapper,{label:"Contacto",children:e.jsx(Ce,{placeholder:"Ej: policia@municipio.es...",value:u.Contacto||null,onChange:l=>f("Contacto",l),data:(s==null?void 0:s.contactos)||[],loading:p,disabled:i})}),e.jsx(ie,{label:"Ubicación (Lat, Lon / Enlace Maps)",placeholder:"Ej: 40.123, -3.456 o enlace Google Maps",value:u.UbicacionInput||"",onChange:l=>f("UbicacionInput",l.currentTarget.value),disabled:i}),e.jsx(ie,{label:"Ruta Imagen (opcional)",placeholder:"Ej: /static/images/lector1.jpg",value:u.Imagen_Path||"",onChange:l=>f("Imagen_Path",l.currentTarget.value),disabled:i})]}),e.jsx(Qa,{label:"Texto Libre / Notas",placeholder:"Añade información adicional sobre el lector",value:u.Texto_Libre||"",onChange:l=>f("Texto_Libre",l.currentTarget.value),rows:3,disabled:i,mt:"md"}),e.jsxs(w,{justify:"flex-end",mt:"xl",children:[e.jsx(I,{variant:"default",onClick:x,disabled:i,children:"Cancelar"}),e.jsx(I,{onClick:G,loading:i,children:"Guardar Cambios"})]})]})},ia=[{value:"ID_Lector",label:"ID Lector"},{value:"Nombre",label:"Nombre"},{value:"Carretera",label:"Carretera"},{value:"Provincia",label:"Provincia"},{value:"Localidad",label:"Localidad"},{value:"Sentido",label:"Sentido de circulación"},{value:"Orientacion",label:"Orientación"},{value:"Coordenada_Y",label:"Latitud"},{value:"Coordenada_X",label:"Longitud"},{value:"Organismo_Regulador",label:"Organismo"},{value:"Notas",label:"Notas"}],fr=({opened:h,onClose:g,onImport:n})=>{const[k,u]=t.useState(null),[y,i]=t.useState([]),[j,s]=t.useState([]),[v,p]=t.useState(!1),[c,f]=t.useState({}),[G,x]=t.useState("upload"),l=async C=>{if(!C){u(null),s([]),i([]),f({}),x("upload");return}u(C),p(!0);try{const T=await C.arrayBuffer(),b=la(T),ce=b.SheetNames[0],H=b.Sheets[ce],U=Le.sheet_to_json(H,{header:1});if(U.length>0){const Y=U[0].map(F=>String(F||"").trim()).filter(F=>F!=="");if(Y.length===0)throw new Error("No se encontraron encabezados válidos en el archivo.");s(Y);const P={};Y.forEach(F=>{const N=F.toLowerCase(),M=ia.find(D=>D.value.toLowerCase()===N||D.label.toLowerCase().includes(N));M&&(P[F]=M.value)}),f(P);const $=U.slice(1,6).map(F=>{const N={};return Y.forEach((M,D)=>{N[M]=F[D]!==void 0?String(F[D]):""}),N});i($),x("mapping")}else throw new Error("El archivo está vacío.")}catch(T){console.error("Error procesando archivo Excel:",T),E.show({title:"Error al procesar archivo",message:T instanceof Error?T.message:"No se pudo leer el archivo Excel. Asegúrate de que sea un formato válido.",color:"red",icon:e.jsx(ke,{size:16})}),u(null),s([]),i([]),f({}),x("upload")}finally{p(!1)}},X=()=>{if(Object.keys(c).length===0){E.show({title:"Mapeo incompleto",message:"Debes mapear al menos un campo para continuar.",color:"red",icon:e.jsx(ke,{size:16})});return}x("preview")},z=async()=>{if(k){p(!0);try{const C=await k.arrayBuffer(),T=la(C),b=T.SheetNames[0],ce=T.Sheets[b],U=Le.sheet_to_json(ce).map(P=>{const $={},F=Object.keys(c).find(M=>c[M]==="Coordenada_Y"),N=Object.keys(c).find(M=>c[M]==="Coordenada_X");if(F&&N&&P[F]!==void 0&&P[N]!==void 0){const M=String(P[F]).replace(",",".").trim(),D=String(P[N]).replace(",",".").trim(),re=parseFloat(M),W=parseFloat(D);!isNaN(re)&&!isNaN(W)&&($.Coordenada_Y=re,$.Coordenada_X=W)}return Object.entries(c).forEach(([M,D])=>{P[M]!==void 0&&D!=="Coordenada_Y"&&D!=="Coordenada_X"&&($[D]=String(P[M]))}),$.ID_Lector?($.ID_Lector=String($.ID_Lector).trim(),$.ID_Lector?$:(console.warn("ID de lector vacío después de trim:",P),null)):(console.warn("Lector sin ID encontrado:",P),null)}).filter(P=>P!==null&&Object.keys(P).length>0);if(U.length===0)throw new Error("No hay datos válidos para importar.");console.log("Datos procesados para importar:",U);const Y=await n(U);E.show({title:"Importación completada",message:Y?`Se han importado ${Y.imported} lectores nuevos y actualizado ${Y.updated} existentes`:`Se han procesado ${U.length} lectores correctamente.`,color:"green"}),ae()}catch(C){console.error("Error en la importación:",C),E.show({title:"Error en la importación",message:C instanceof Error?C.message:"Ocurrió un error durante la importación.",color:"red",icon:e.jsx(ke,{size:16})})}finally{p(!1)}}},ae=()=>{u(null),i([]),s([]),f({}),x("upload"),g()};return e.jsxs(we,{opened:h,onClose:ae,title:"Importar Lectores",size:"xl",overlayProps:{backgroundOpacity:.55,blur:3},children:[e.jsx(Me,{visible:v}),G==="upload"&&e.jsxs(A,{p:"md",children:[e.jsx(J,{order:4,mb:"md",children:"Paso 1: Seleccionar archivo"}),e.jsx(R,{mb:"md",children:"Selecciona un archivo Excel (.xlsx) con los datos de los lectores a importar. El archivo debe contener al menos las columnas para ID Lector y Nombre."}),e.jsx(rr,{label:"Archivo Excel",placeholder:"Seleccionar archivo",accept:".xlsx,.xls",value:k,onChange:l,leftSection:e.jsx(Xa,{size:16}),required:!0}),e.jsx(Te,{color:"blue",title:"Información",icon:e.jsx(or,{}),mt:"lg",children:"Asegúrate de que tu archivo Excel tenga una fila de encabezados clara. En el siguiente paso podrás mapear las columnas a los campos del sistema."})]}),G==="mapping"&&j.length>0&&e.jsxs(A,{p:"md",children:[e.jsx(J,{order:4,mb:"md",children:"Paso 2: Mapear columnas"}),e.jsx(R,{mb:"md",children:'Asigna cada columna del archivo a su correspondiente campo en el sistema. Los campos marcados como "requerido" deben ser mapeados obligatoriamente.'}),e.jsx(Ee,{cols:2,mb:"md",children:j.map(C=>e.jsx(ee,{label:`Columna "${C}"`,placeholder:"Seleccionar campo",data:[{value:"",label:"Seleccionar campo",disabled:!0},...ia],value:c[C]||"",onChange:T=>{if(T)f(b=>({...b,[C]:T}));else{const b={...c};delete b[C],f(b)}},clearable:!0,searchable:!0},C))}),y.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(ha,{my:"md"}),e.jsx(J,{order:5,mb:"sm",children:"Vista previa de datos"}),e.jsx(A,{style:{overflowX:"auto"},children:e.jsxs(L,{striped:!0,highlightOnHover:!0,withTableBorder:!0,children:[e.jsx(L.Thead,{children:e.jsx(L.Tr,{children:j.map(C=>e.jsx(L.Th,{children:C},C))})}),e.jsx(L.Tbody,{children:y.map((C,T)=>e.jsx(L.Tr,{children:j.map(b=>e.jsx(L.Td,{children:C[b]!==void 0?String(C[b]):""},`${T}-${b}`))},T))})]})})]}),e.jsxs(w,{justify:"right",mt:"xl",children:[e.jsx(I,{variant:"outline",onClick:()=>x("upload"),children:"Atrás"}),e.jsx(I,{onClick:X,children:"Continuar"})]})]}),G==="preview"&&e.jsxs(A,{p:"md",children:[e.jsx(J,{order:4,mb:"md",children:"Paso 3: Confirmar importación"}),e.jsx(R,{mb:"md",children:"Revisa la configuración y confirma la importación."}),e.jsxs(tr,{withBorder:!0,p:"md",radius:"md",mb:"md",children:[e.jsx(J,{order:5,mb:"sm",children:"Resumen de mapeo"}),e.jsx(Ee,{cols:2,children:Object.entries(c).map(([C,T])=>e.jsxs(R,{children:[e.jsx("strong",{children:C})," → ",T]},C))})]}),e.jsx(Te,{color:"yellow",title:"Importante",icon:e.jsx(ke,{}),children:"Esta acción importará los datos al sistema. Asegúrate de que el mapeo sea correcto. Los lectores con ID repetido actualizarán los existentes."}),e.jsxs(w,{justify:"right",mt:"xl",children:[e.jsx(I,{variant:"outline",onClick:()=>x("mapping"),children:"Atrás"}),e.jsx(I,{color:"green",leftSection:e.jsx(ma,{size:16}),onClick:z,children:"Importar Lectores"})]})]})]})};function vr({opened:h,onClose:g,selectedLectorIds:n,onSave:k,provincias:u,localidades:y,carreteras:i,organismos:j,sentidos:s=["Creciente","Decreciente"]}){const[v,p]=t.useState(!1),[c,f]=t.useState({Provincia:void 0,Carretera:void 0,Organismo_Regulador:void 0,Sentido:void 0,Localidad:void 0}),G=async()=>{if(n.length!==0){p(!0);try{const x=n.map(l=>pa(l,c));await Promise.all(x),E.show({title:"Actualización Completada",message:`Se han actualizado ${n.length} lectores correctamente.`,color:"green"}),k(),g()}catch(x){console.error("Error al actualizar lectores:",x),E.show({title:"Error en la Actualización",message:"Hubo un error al actualizar los lectores. Por favor, inténtalo de nuevo.",color:"red"})}finally{p(!1)}}};return e.jsx(we,{opened:h,onClose:g,title:`Editar ${n.length} lectores`,size:"md",children:e.jsxs(Se,{children:[e.jsx(R,{size:"sm",c:"dimmed",children:"Los campos que dejes vacíos no se modificarán en los lectores seleccionados."}),e.jsx(ee,{label:"Localidad",placeholder:"Dejar vacío para no modificar",data:y,value:c.Localidad||"",onChange:x=>f(l=>({...l,Localidad:x||void 0})),searchable:!0,clearable:!0}),e.jsx(ee,{label:"Provincia",placeholder:"Dejar vacío para no modificar",data:u,value:c.Provincia||"",onChange:x=>f(l=>({...l,Provincia:x||void 0})),searchable:!0,clearable:!0}),e.jsx(ee,{label:"Carretera",placeholder:"Dejar vacío para no modificar",data:i,value:c.Carretera||"",onChange:x=>f(l=>({...l,Carretera:x||void 0})),searchable:!0,clearable:!0}),e.jsx(ee,{label:"Organismo Regulador",placeholder:"Dejar vacío para no modificar",data:j,value:c.Organismo_Regulador||"",onChange:x=>f(l=>({...l,Organismo_Regulador:x||void 0})),searchable:!0,clearable:!0}),e.jsx(ee,{label:"Sentido",placeholder:"Dejar vacío para no modificar",data:s,value:c.Sentido||"",onChange:x=>f(l=>({...l,Sentido:x||void 0})),clearable:!0}),e.jsxs(w,{justify:"flex-end",mt:"md",children:[e.jsx(I,{variant:"default",onClick:g,children:"Cancelar"}),e.jsx(I,{onClick:G,loading:v,disabled:n.length===0,children:"Guardar Cambios"})]})]})})}function Cr({opened:h,onClose:g,onExport:n,sugerencias:k}){const[u,y]=t.useState(!1),[i,j]=t.useState({nombre:"",provincia:[],carretera:[],organismo:[],localidad:[]}),s=async()=>{y(!0);try{await n(i),E.show({title:"Exportación Completada",message:"Los lectores se han exportado correctamente",color:"green"}),g()}catch(v){console.error("Error al exportar:",v),E.show({title:"Error en la Exportación",message:v instanceof Error?v.message:"Error desconocido al exportar",color:"red"})}finally{y(!1)}};return e.jsxs(we,{opened:h,onClose:g,title:"Exportar Lectores",size:"lg",children:[e.jsx(Me,{visible:u}),e.jsxs(Se,{children:[e.jsx(R,{size:"sm",c:"dimmed",children:"Selecciona los filtros para exportar los lectores. Deja los campos vacíos para exportar todos los lectores."}),e.jsx(ie,{label:"Buscar por nombre",placeholder:"Escribe para buscar...",value:i.nombre,onChange:v=>j(p=>({...p,nombre:v.target.value}))}),e.jsx(B,{label:"Filtrar por provincia",placeholder:"Selecciona provincias",data:k.provincias,value:i.provincia,onChange:v=>j(p=>({...p,provincia:v})),searchable:!0,clearable:!0}),e.jsx(B,{label:"Filtrar por carretera",placeholder:"Selecciona carreteras",data:k.carreteras,value:i.carretera,onChange:v=>j(p=>({...p,carretera:v})),searchable:!0,clearable:!0}),e.jsx(B,{label:"Filtrar por organismo",placeholder:"Selecciona organismos",data:k.organismos,value:i.organismo,onChange:v=>j(p=>({...p,organismo:v})),searchable:!0,clearable:!0}),e.jsx(B,{label:"Filtrar por localidad",placeholder:"Selecciona localidades",data:k.localidades,value:i.localidad,onChange:v=>j(p=>({...p,localidad:v})),searchable:!0,clearable:!0}),e.jsxs(w,{justify:"flex-end",mt:"md",children:[e.jsx(I,{variant:"default",onClick:g,children:"Cancelar"}),e.jsx(I,{leftSection:e.jsx(ga,{size:18}),onClick:s,loading:u,children:"Exportar"})]})]})]})}delete V.Icon.Default.prototype._getIconUrl;V.Icon.Default.mergeOptions({iconRetinaUrl:"https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon-2x.png",iconUrl:"https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon.png",shadowUrl:"https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png"});V.divIcon({html:'<span style="background-color: fuchsia; width: 8px; height: 8px; border-radius: 50%; display: inline-block; border: 1px solid darkmagenta;"></span>',className:"custom-div-icon",iconSize:[8,8],iconAnchor:[4,4]});V.divIcon({html:'<span style="background-color: #011638; width: 24px; height: 24px; border-radius: 50%; display: inline-block; border: 3px solid #222; box-shadow: 0 0 0 4px rgba(1,22,56,0.15);"></span>',className:"custom-div-icon",iconSize:[24,24],iconAnchor:[12,12]});V.divIcon({html:'<span style="background-color: #011638; width: 16px; height: 16px; border-radius: 50%; display: inline-block; border: 2px solid white; box-shadow: 0 0 4px rgba(0,0,0,0.4);"></span>',className:"custom-div-icon",iconSize:[16,16],iconAnchor:[8,8]});function Sr(h){if(h&&(h instanceof V.Polygon||h instanceof V.Rectangle))try{return h.toGeoJSON().geometry}catch(g){return console.error("Error al convertir la forma a GeoJSON:",g),null}return null}const Lr=[{id:"tabla",label:"Tabla",icon:gr,section:"vista"},{id:"mapa",label:"Mapa",icon:ir,section:"vista"}];function Er({provinciasUnicas:h,carreterasUnicas:g,organismosUnicos:n,lectorSearchSuggestions:k,filtroProvincia:u,setFiltroProvincia:y,filtroCarretera:i,setFiltroCarretera:j,filtroOrganismo:s,setFiltroOrganismo:v,filtroTextoLibre:p,setFiltroTextoLibre:c,filtroLocalidad:f,setFiltroLocalidad:G,localidadesUnicas:x,mapLoading:l}){const X=()=>{y([]),j([]),v([]),c(""),G([])};return e.jsxs(Ne,{p:"md",shadow:"xs",radius:"md",mb:"md",withBorder:!0,children:[e.jsxs(w,{justify:"space-between",mb:"md",children:[e.jsx(J,{order:4,children:"Filtros"}),e.jsx(I,{variant:"light",color:"blue",size:"xs",onClick:X,leftSection:e.jsx(da,{size:14}),children:"Limpiar Filtros"})]}),e.jsxs(Ee,{cols:{base:1,sm:2,md:3,lg:1},spacing:"xs",children:[e.jsx(B,{label:"Filtrar por Provincia",placeholder:"Todas las provincias",data:h,value:u,onChange:y,searchable:!0,clearable:!0,disabled:l}),e.jsx(B,{label:"Filtrar por Localidad",placeholder:"Todas las localidades",data:x,value:f,onChange:G,searchable:!0,clearable:!0,disabled:l}),e.jsx(B,{label:"Filtrar por Carretera",placeholder:"Todas las carreteras",data:g,value:i,onChange:j,searchable:!0,clearable:!0,disabled:l}),e.jsx(B,{label:"Filtrar por Organismo",placeholder:"Todos los organismos",data:n,value:s,onChange:v,searchable:!0,clearable:!0,disabled:l}),e.jsx(xa,{label:"Buscar por ID/Nombre",placeholder:"Escribe para buscar...",data:k,value:p,onChange:c,limit:10,clearable:!0,disabled:l})]})]})}function wr({lectores:h}){return e.jsxs(Ne,{p:"md",shadow:"xs",radius:"md",withBorder:!0,style:{height:520,display:"flex",flexDirection:"column"},children:[e.jsx(J,{order:4,pb:0,children:"Lectores Filtrados"}),e.jsx(Wa,{h:440,style:{flex:1},children:e.jsxs(L,{striped:!0,highlightOnHover:!0,withTableBorder:!0,children:[e.jsx(L.Thead,{children:e.jsxs(L.Tr,{children:[e.jsx(L.Th,{children:"ID Lector"}),e.jsx(L.Th,{children:"Nombre"}),e.jsx(L.Th,{children:"Carretera"}),e.jsx(L.Th,{children:"Provincia"}),e.jsx(L.Th,{children:"Organismo"})]})}),e.jsx(L.Tbody,{children:h.length>0?h.map(g=>e.jsxs(L.Tr,{children:[e.jsx(L.Td,{children:g.ID_Lector}),e.jsx(L.Td,{children:g.Nombre||"-"}),e.jsx(L.Td,{children:g.Carretera||"-"}),e.jsx(L.Td,{children:g.Provincia||"-"}),e.jsx(L.Td,{children:g.Organismo_Regulador||"-"})]},`list-${g.ID_Lector}`)):e.jsx(L.Tr,{children:e.jsx(L.Td,{colSpan:6,children:e.jsx(R,{c:"dimmed",ta:"center",children:"No hay lectores que coincidan con los filtros actuales."})})})})]})})]})}function Xr(){var Ke,Qe,ea;const[h,g]=t.useState([]),[n,k]=t.useState(!0),[u,y]=t.useState(null),[i,j]=t.useState({page:1,pageSize:50,totalCount:0}),[s,v]=t.useState({columnAccessor:"ID_Lector",direction:"asc"}),[p,{open:c,close:f}]=fe(!1),[G,x]=t.useState(null),[l,X]=t.useState(null),[z,ae]=t.useState([]),T=(Ke=Ya().state)==null?void 0:Ke.initialTab,[b,ce]=t.useState(T==="mapa"?"mapa":"tabla"),[H,U]=t.useState([]),[Y,P]=t.useState(!1),[$,F]=t.useState(null),[N,M]=t.useState([]),[D,re]=t.useState([]),[W,ye]=t.useState([]),[oe,De]=t.useState(""),[Z,Be]=t.useState([]),[ba,{open:ja,close:Ue}]=fe(!1),[qe,Ge]=t.useState(null),[yr,{toggle:Dr}]=fe(!1),[fa,{open:va,close:Xe}]=fe(!1),[K,Ca]=t.useState({provincias:[],localidades:[],carreteras:[],organismos:[],contactos:[]}),[Sa,{open:La,close:Ye}]=fe(!1),[q,We]=t.useState(null),[se,ze]=t.useState([]),[_,Q]=t.useState({nombre:"",color:"#011638"}),[Ea,de]=t.useState(!1),[le,Pe]=t.useState(null),Fe=t.useRef(null);t.useEffect(()=>{b==="mapa"&&(M([]),re([]),ye([]),De(""),U(h.map(a=>({...a,Coordenada_X:a.Coordenada_X??0,Coordenada_Y:a.Coordenada_Y??0}))))},[b,h]);const ue=t.useCallback(async()=>{k(!0),y(null);try{const a={skip:(i.page-1)*i.pageSize,limit:i.pageSize,...oe&&{texto_libre:oe},...N.length>0&&{provincia:N[0]},...D.length>0&&{carretera:D[0]},...W.length>0&&{organismo:W[0]},...Z.length>0&&{localidad:Z[0]},sort:s.columnAccessor,order:s.direction},r=await ra(a);g(r.lectores),j(o=>({...o,totalCount:r.total_count}))}catch(a){console.error("Error al cargar lectores:",a),y(a instanceof Error?a.message:"Error al cargar los lectores"),E.show({title:"Error",message:"No se pudieron cargar los lectores. Por favor, intenta de nuevo.",color:"red"})}finally{k(!1)}},[i.page,i.pageSize,oe,N,D,W,Z,s]);t.useEffect(()=>{b==="tabla"&&ue()},[ue,b]),t.useEffect(()=>{b==="tabla"&&j(a=>({...a,page:1}))},[s,b]);const Re=t.useCallback(async()=>{if(b==="mapa"){P(!0),F(null);try{const a=await Ha();U(a)}catch(a){F(a.message||"Error al cargar los datos para el mapa."),U([])}finally{P(!1)}}},[b]);t.useEffect(()=>{b==="mapa"&&Re()},[b,Re]),t.useEffect(()=>{b==="mapa"&&(M([]),re([]),ye([]),De(""))},[b]),console.log("[MapFilters] Datos base mapLectores:",H);const pe=t.useMemo(()=>K.provincias.sort(),[K.provincias]),he=t.useMemo(()=>K.carreteras.sort().map(a=>({value:a,label:a})),[K.carreteras]),_e=t.useMemo(()=>K.organismos.sort().map(a=>({value:a,label:a})),[K.organismos]),Ie=t.useMemo(()=>K.localidades.sort().map(a=>({value:a,label:a})),[K.localidades]),He=t.useMemo(()=>{const a=new Set;return[...h,...H].forEach(r=>{r.ID_Lector&&a.add(r.ID_Lector),r.Nombre&&a.add(r.Nombre)}),Array.from(a).sort()},[h,H]),Je=t.useMemo(()=>{const a=oe.toLowerCase().trim(),r=Sr(qe);return H.filter(o=>{const d=N.length===0||o.Provincia&&N.includes(o.Provincia),O=D.length===0||o.Carretera&&D.includes(o.Carretera),m=W.length===0||o.Organismo_Regulador&&W.includes(o.Organismo_Regulador),ge=Z.length===0||o.Localidad&&Z.includes(o.Localidad),xe=a===""||o.ID_Lector&&o.ID_Lector.toLowerCase().includes(a)||o.Nombre&&o.Nombre.toLowerCase().includes(a);let be=!0;if(r&&o.Coordenada_X!=null&&o.Coordenada_Y!=null)try{const je=lr([o.Coordenada_X,o.Coordenada_Y]);be=nr(je,r)}catch(je){console.error("Error en comprobación espacial con Turf.js:",je),be=!1}return d&&O&&m&&ge&&xe&&be})},[H,N,D,W,Z,oe,qe]),wa=t.useCallback(a=>{console.log("Forma dibujada (GeoJSON):",a.toGeoJSON()),Ge(a)},[]),ya=t.useCallback(()=>{console.log("handleShapeDeleted llamado"),Ge(a=>(console.log("Estado drawnShape antes:",a),console.log("Estado drawnShape después: null"),null))},[]),Da=a=>{j(r=>({...r,page:a}))},_a=a=>{j(r=>({...r,page:1,pageSize:a}))},Ia=a=>{x(a),c()},Ve=()=>{x(null),f()},ka=async(a,r)=>{try{await pa(a,r),E.show({title:"Lector actualizado",message:`El lector ${a} se ha actualizado correctamente.`,color:"green",icon:e.jsx(Oe,{})}),g(o=>o.map(d=>d.ID_Lector===a?{...d,...r}:d)),U(o=>o.map(d=>d.ID_Lector===a?{...d,...r}:d)),Ve()}catch(o){console.error("Error al guardar el lector:",o),E.show({title:"Error",message:"No se pudo guardar el lector.",color:"red"})}},Oa=async(a,r)=>{if(window.confirm(`¿Estás seguro de que quieres eliminar el lector ${r||a}? Esta acción no se puede deshacer.`)){X(a);try{await oa(a),E.show({title:"Lector eliminado",message:`El lector ${r||a} ha sido eliminado.`,color:"green",icon:e.jsx(Oe,{})}),g(d=>d.filter(O=>O.ID_Lector!==a)),ae(d=>d.filter(O=>O!==a)),j(d=>({...d,totalCount:d.totalCount-1}))}catch(d){console.error("Error al eliminar el lector:",d),E.show({title:"Error",message:"No se pudo eliminar el lector.",color:"red"})}finally{X(null)}}},Ta=async a=>{console.log("Exportando con filtros:",a);try{const o=(await ra({...a,limit:0})).lectores,d=Le.json_to_sheet(o),O=Le.book_new();Le.book_append_sheet(O,d,"Lectores"),ar(O,"lectores_exportados.xlsx"),E.show({title:"Exportación completada",message:`Se han exportado ${o.length} lectores.`,color:"green"})}catch(r){console.error("Error al exportar lectores:",r),E.show({title:"Error de exportación",message:"No se pudieron exportar los lectores.",color:"red"})}Ye()},Na=async a=>{var r,o;try{await Ka(a),E.show({title:"Importación exitosa",message:"Los lectores se han importado correctamente.",color:"green",icon:e.jsx(Oe,{})}),ue(),Ue()}catch(d){console.error("Error al importar lectores:",d);const O=((o=(r=d.response)==null?void 0:r.data)==null?void 0:o.detail)||"No se pudieron importar los lectores.";E.show({title:"Error de importación",message:O,color:"red"})}},Ze=h.length>0&&z.length===h.length,Ma=z.length>0&&!Ze,za=a=>{const r=a.currentTarget.checked;ae(r?h.map(o=>o.ID_Lector):[])},Pa=(a,r)=>{ae(r?[...z,a]:z.filter(o=>o!==a))},Fa=async()=>{if(!window.confirm(`¿Estás seguro de que quieres eliminar ${z.length} lectores? Esta acción no se puede deshacer.`))return;let r=0,o=0;for(const d of z)try{await oa(d),r++}catch(O){console.error(`Error al eliminar lector ${d}:`,O),o++}r>0&&E.show({title:"Eliminación completada",message:`${r} lectores eliminados.`,color:"green",icon:e.jsx(Oe,{})}),o>0&&E.show({title:"Error en eliminación",message:`No se pudieron eliminar ${o} lectores.`,color:"red"}),ae([]),ue()},Ra=async()=>{Xe(),ue(),Re()},$a=async()=>{try{const a=await ua();Ca(a)}catch(a){console.error("Error al cargar sugerencias:",a)}};t.useEffect(()=>{$a()},[]);const Aa=()=>{const a=(r,o)=>{ze(se.map(d=>d.id===r?{...d,activa:o}:d))};return e.jsxs(Ne,{p:"md",shadow:"xs",radius:"md",mt:"lg",withBorder:!0,children:[e.jsxs(w,{justify:"space-between",mb:"sm",children:[e.jsx(J,{order:4,children:"Capas"}),e.jsx(I,{size:"xs",variant:"light",onClick:()=>{Pe(null),Q({nombre:"",color:"#011638",criterios:{},activa:!0}),de(!0)},leftSection:e.jsx(sa,{size:14}),children:"Nueva Capa"})]}),se.length>0&&e.jsx(Se,{gap:"xs",children:se.map(r=>e.jsx(Ne,{p:"xs",withBorder:!0,radius:"sm",children:e.jsxs(w,{justify:"space-between",children:[e.jsxs(w,{children:[e.jsx(ur,{color:r.color,size:20}),e.jsx(R,{children:r.nombre})]}),e.jsxs(w,{children:[e.jsx(ve,{variant:"subtle",onClick:()=>{Pe(r),Q(r),de(!0)},children:e.jsx(Ae,{size:16})}),e.jsx(mr,{checked:r.activa,onChange:o=>a(r.id,o.currentTarget.checked),size:"md"})]})]})},r.id))})]})},Ba=()=>{var o,d,O;const a=()=>{if(!_.nombre){E.show({title:"Error",message:"El nombre de la capa no puede estar vacío.",color:"red"});return}if(le)ze(se.map(m=>m.id===le.id?{..._,id:m.id}:m)),E.show({title:"Capa actualizada",message:`La capa "${_.nombre}" ha sido actualizada.`,color:"blue"});else{const m={..._,id:`capa-${Date.now()}`,activa:_.activa??!0,criterios:_.criterios??{}};ze([...se,m]),E.show({title:"Capa creada",message:`La capa "${_.nombre}" ha sido creada.`,color:"green"})}de(!1),Pe(null),Q({nombre:"",color:"#011638"})},r=!!le;return e.jsx(we,{opened:Ea,onClose:()=>de(!1),title:r?`Editando Capa: ${le==null?void 0:le.nombre}`:"Crear Nueva Capa",size:"lg",children:e.jsxs(Se,{children:[e.jsx(ie,{label:"Nombre de la Capa",placeholder:"Ej: Lectores A-1 Madrid",required:!0,value:_.nombre||"",onChange:m=>Q({..._,nombre:m.currentTarget.value})}),e.jsx(hr,{label:"Color de la Capa",value:_.color||"#011638",onChange:m=>Q({..._,color:m})}),e.jsx(ha,{label:"Criterios de filtrado",labelPosition:"center",my:"sm"}),e.jsx(B,{label:"Provincias",placeholder:"Cualquier provincia",data:pe,value:((o=_.criterios)==null?void 0:o.provincia)||[],onChange:m=>Q({..._,criterios:{..._.criterios,provincia:m}}),searchable:!0}),e.jsx(B,{label:"Carreteras",placeholder:"Cualquier carretera",data:he,value:((d=_.criterios)==null?void 0:d.carretera)||[],onChange:m=>Q({..._,criterios:{..._.criterios,carretera:m}}),searchable:!0}),e.jsx(ie,{label:"Texto en ID o Nombre",placeholder:"Ej: M30",value:((O=_.criterios)==null?void 0:O.texto)||"",onChange:m=>Q({..._,criterios:{..._.criterios,texto:m.currentTarget.value}})}),e.jsxs(w,{justify:"flex-end",mt:"md",children:[e.jsx(I,{variant:"default",onClick:()=>de(!1),children:"Cancelar"}),e.jsx(I,{onClick:a,children:r?"Guardar cambios":"Crear capa"})]})]})})},Ua=async()=>{const a=document.querySelector(".leaflet-container");if(a)try{const r=await pr(a,{useCORS:!0,allowTaint:!0,backgroundColor:null}),o=document.createElement("a");o.download=`mapa-lectores-${new Date().toISOString().split("T")[0]}.png`,o.href=r.toDataURL("image/png"),o.click()}catch(r){console.error("Error al exportar el mapa:",r),E.show({title:"Error",message:"No se pudo exportar el mapa",color:"red"})}},$e=se.filter(a=>a.activa&&a.criterios),S=a=>a==null?void 0:a.toLowerCase().trim(),me=$e.length>0?Je.filter(a=>$e.some(r=>{const o=r.criterios||{},d=!o.provincia||a.Provincia&&o.provincia.map(S).includes(S(a.Provincia)),O=!o.carretera||a.Carretera&&o.carretera.map(S).includes(S(a.Carretera)),m=!o.organismo||a.Organismo_Regulador&&o.organismo.map(S).includes(S(a.Organismo_Regulador)),ge=!o.localidad||a.Localidad&&o.localidad.map(S).includes(S(a.Localidad)),xe=!o.texto||a.ID_Lector&&S(a.ID_Lector).includes(S(o.texto))||a.Nombre&&S(a.Nombre).includes(S(o.texto));return d&&O&&m&&ge&&xe})):Je;return t.useEffect(()=>{if(!Fe.current||me.length===0)return;const a=V.latLngBounds(me.map(r=>[r.Coordenada_Y,r.Coordenada_X]));a.isValid()&&Fe.current.fitBounds(a,{padding:[40,40]})},[me]),e.jsxs(A,{p:"md",style:{paddingLeft:32,paddingRight:32},children:[e.jsxs(w,{justify:"space-between",mb:"xl",children:[e.jsx(J,{order:2,children:"Gestión de Lectores"}),e.jsxs(w,{children:[e.jsx(I,{leftSection:e.jsx(sa,{size:18}),onClick:c,variant:"outline",color:"green",disabled:n,children:"Añadir Lector"}),e.jsxs(I,{leftSection:e.jsx(Ae,{size:18}),onClick:va,variant:"outline",color:"blue",disabled:z.length===0||n,children:["Editar Selección (",z.length,")"]}),e.jsxs(I,{leftSection:e.jsx(aa,{size:18}),onClick:Fa,color:"red",variant:"outline",disabled:z.length===0||n,children:["Eliminar Selección (",z.length,")"]}),e.jsx(I,{leftSection:e.jsx(ma,{size:18}),onClick:ja,variant:"outline",color:"teal",disabled:n,children:"Importar Lectores"}),e.jsx(I,{leftSection:e.jsx(ga,{size:18}),onClick:La,variant:"outline",color:"blue",disabled:n,children:"Exportar Lectores"})]})]}),e.jsx(w,{gap:0,align:"flex-start",mb:"md",children:e.jsx(A,{children:e.jsx(w,{gap:"xs",children:Lr.map(a=>e.jsx(I,{variant:b===a.id?"filled":"light",leftSection:e.jsx(a.icon,{size:16}),onClick:()=>ce(a.id),color:"#2b4fcf",children:a.label},a.id))})})}),b==="tabla"&&e.jsxs(A,{style:{position:"relative"},children:[e.jsx(Me,{visible:n,overlayProps:{radius:"sm",blur:2}}),u&&e.jsx(Te,{color:"red",title:"Error en Tabla",children:u}),!u&&e.jsxs(e.Fragment,{children:[e.jsxs(Ee,{cols:{base:1,sm:2,md:3,lg:5},mb:"md",children:[e.jsx(B,{label:"Filtrar por Provincia",placeholder:"Todas las provincias",data:pe,value:N,onChange:M,searchable:!0,clearable:!0}),e.jsx(B,{label:"Filtrar por Localidad",placeholder:"Todas las localidades",data:Ie.map(a=>a.value),value:Z,onChange:Be,searchable:!0,clearable:!0}),e.jsx(B,{label:"Filtrar por Carretera",placeholder:"Todas las carreteras",data:he.map(a=>a.value),value:D,onChange:re,searchable:!0,clearable:!0}),e.jsx(B,{label:"Filtrar por Organismo",placeholder:"Todos los organismos",data:_e.map(a=>a.value),value:W,onChange:ye,searchable:!0,clearable:!0}),e.jsx(xa,{label:"Buscar por ID / Nombre",placeholder:"Escribe para buscar...",data:He,value:oe,onChange:De,limit:10,clearable:!0})]}),e.jsx(sr,{withTableBorder:!0,striped:!0,highlightOnHover:!0,verticalSpacing:"sm",records:h,columns:[{accessor:"select",title:e.jsx(na,{"aria-label":"Seleccionar todas las filas",checked:Ze,indeterminate:Ma,onChange:za,disabled:h.length===0||n}),render:a=>e.jsx(na,{"aria-label":`Seleccionar lector ${a.ID_Lector}`,checked:z.includes(a.ID_Lector),onChange:r=>Pa(a.ID_Lector,r.currentTarget.checked),disabled:n}),width:40},{accessor:"ID_Lector",title:"ID Lector",sortable:!0},{accessor:"Nombre",title:"Nombre",sortable:!0},{accessor:"Carretera",title:"Carretera",sortable:!0},{accessor:"Provincia",title:"Provincia",sortable:!0},{accessor:"Localidad",title:"Localidad",sortable:!0},{accessor:"Coordenada_Y",title:"Latitud",sortable:!0,render:a=>{var r;return((r=a.Coordenada_Y)==null?void 0:r.toFixed(6))||"-"}},{accessor:"Coordenada_X",title:"Longitud",sortable:!0,render:a=>{var r;return((r=a.Coordenada_X)==null?void 0:r.toFixed(6))||"-"}},{accessor:"Organismo_Regulador",title:"Organismo",sortable:!0},{accessor:"actions",title:"Acciones",render:a=>e.jsxs(w,{gap:"xs",children:[e.jsx(ta,{label:"Editar Lector",children:e.jsx(ve,{variant:"subtle",color:"blue",onClick:()=>Ia(a),disabled:l===a.ID_Lector||n,children:e.jsx(Ae,{size:16})})}),e.jsx(ta,{label:"Eliminar Lector",children:e.jsx(ve,{variant:"subtle",color:"red",onClick:()=>Oa(a.ID_Lector,a.Nombre),loading:l===a.ID_Lector,disabled:l!==null||n||z.length>0,children:e.jsx(aa,{size:16})})})]})}],sortStatus:s,onSortStatusChange:v,totalRecords:i.totalCount,recordsPerPage:i.pageSize,page:i.page,onPageChange:Da,idAccessor:"ID_Lector",recordsPerPageOptions:[25,50,100],onRecordsPerPageChange:_a,paginationText:({from:a,to:r,totalRecords:o})=>`Mostrando ${a}-${r} de ${o}`})]})]}),b==="mapa"&&e.jsxs(A,{pt:"xs",style:{position:"relative",zIndex:1},children:[Y&&e.jsx(ca,{my:"xl"}),$&&e.jsx(Te,{color:"red",title:"Error en Mapa",children:$}),!Y&&!$&&e.jsxs(w,{align:"flex-start",gap:24,style:{width:"100%",minHeight:"450px"},children:[e.jsxs(A,{style:{display:"flex",flexDirection:"column",minWidth:520,maxWidth:650,borderRight:"1px solid #eee",height:"calc(100vh - 300px)"},children:[e.jsx(Er,{provinciasUnicas:pe,carreterasUnicas:he.map(a=>a.value),organismosUnicos:_e.map(a=>a.value),lectorSearchSuggestions:He,filtroProvincia:N,setFiltroProvincia:M,filtroCarretera:D,setFiltroCarretera:re,filtroOrganismo:W,setFiltroOrganismo:ye,filtroTextoLibre:oe,setFiltroTextoLibre:De,filtroLocalidad:Z,setFiltroLocalidad:Be,localidadesUnicas:Ie.map(a=>a.value),mapLoading:Y}),e.jsx(Aa,{}),e.jsx(A,{style:{flex:1,display:"flex",flexDirection:"column"},children:e.jsx(wr,{lectores:me})})]}),e.jsxs(A,{style:{flex:1,height:"calc(100vh - 300px)",minHeight:"450px",position:"relative"},children:[q&&e.jsx(A,{style:{position:"absolute",bottom:20,left:"50%",transform:"translateX(-50%)",zIndex:1e3,backgroundColor:"white",padding:"15px 20px",borderRadius:"8px",boxShadow:"0 2px 10px rgba(0,0,0,0.1)",maxWidth:"90%",width:"auto"},children:e.jsxs(Se,{gap:"xs",children:[e.jsxs(w,{gap:"xs",align:"center",children:[e.jsx(A,{style:{width:"12px",height:"12px",borderRadius:"50%",backgroundColor:q.markerColor||"#011638",flexShrink:0}}),e.jsxs(R,{fw:700,size:"sm",children:[q.ID_Lector,q.Nombre&&` - ${q.Nombre}`]}),e.jsx(ve,{variant:"subtle",color:"gray",onClick:()=>We(null),size:"sm",style:{marginLeft:"auto"},children:e.jsx(da,{size:14})})]}),e.jsxs(w,{gap:"md",children:[e.jsxs(R,{size:"sm",children:[e.jsx("b",{children:"Carretera:"})," ",q.Carretera||"-"]}),e.jsxs(R,{size:"sm",children:[e.jsx("b",{children:"Provincia:"})," ",q.Provincia||"-"]})]}),e.jsxs(w,{gap:"md",children:[e.jsxs(R,{size:"sm",children:[e.jsx("b",{children:"Sentido:"})," ",q.Sentido||"-"]}),e.jsxs(R,{size:"sm",children:[e.jsx("b",{children:"Organismo:"})," ",q.Organismo_Regulador||"-"]})]}),e.jsx(w,{gap:"md",children:e.jsxs(R,{size:"sm",children:[e.jsx("b",{children:"Coordenadas:"})," ",(Qe=q.Coordenada_Y)==null?void 0:Qe.toFixed(6),", ",(ea=q.Coordenada_X)==null?void 0:ea.toFixed(6)]})})]})}),H.length>0?e.jsxs(Ja,{center:[40.416775,-3.70379],zoom:12,scrollWheelZoom:!0,style:{height:"100%",width:"100%"},ref:Fe,children:[e.jsx(Va,{url:"https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",attribution:'© <a href="https://carto.com/attributions">CARTO</a>'}),e.jsx(cr,{onShapeDrawn:wa,onShapeDeleted:ya}),me.map(a=>{const r=q&&q.ID_Lector===a.ID_Lector,o=$e.find(O=>{const m=O.criterios||{},ge=!m.provincia||a.Provincia&&m.provincia.map(S).includes(S(a.Provincia)),xe=!m.carretera||a.Carretera&&m.carretera.map(S).includes(S(a.Carretera)),be=!m.organismo||a.Organismo_Regulador&&m.organismo.map(S).includes(S(a.Organismo_Regulador)),je=!m.localidad||a.Localidad&&m.localidad.map(S).includes(S(a.Localidad)),qa=!m.texto||a.ID_Lector&&S(a.ID_Lector).includes(S(m.texto))||a.Nombre&&S(a.Nombre).includes(S(m.texto));return ge&&xe&&be&&je&&qa}),d=V.divIcon({html:`<span style="
                          background-color: ${a.Sentido==="Creciente"?"#ff0f35":a.Sentido==="Decreciente"?"#00a9d4":(o==null?void 0:o.color)||"#011638"}; 
                          width: ${r?"30px":"20px"}; 
                          height: ${r?"30px":"20px"}; 
                          border-radius: 50%; 
                          display: flex;
                          align-items: center;
                          justify-content: center;
                          border: ${r?"3px solid #222":"2px solid white"}; 
                          box-shadow: ${r?"0 0 0 4px rgba(1,22,56,0.15)":"0 0 4px rgba(0,0,0,0.4)"};
                          font-weight: bold;
                          font-size: ${r?"14px":"12px"};
                          color: ${a.Sentido==="Creciente"?"white":a.Sentido==="Decreciente"?"#1c0021":"transparent"};
                        ">${a.Sentido==="Creciente"?"C":a.Sentido==="Decreciente"?"D":""}</span>`,className:"custom-div-icon",iconSize:r?[30,30]:[20,20],iconAnchor:r?[15,15]:[10,10]});return e.jsx(Za,{position:[a.Coordenada_Y,a.Coordenada_X],icon:d,eventHandlers:{click:()=>{We({...a,lecturas:[],markerColor:a.Sentido==="Creciente"?"#ff0f35":a.Sentido==="Decreciente"?"#00a9d4":(o==null?void 0:o.color)||"#011638"})}}},a.ID_Lector)}),e.jsx(ve,{variant:"default",size:32,style:{position:"absolute",bottom:16,left:16,zIndex:1e3,background:"white",border:"2px solid #234be7",color:"#234be7",boxShadow:"none",fontWeight:700,display:"flex",alignItems:"center",justifyContent:"center",padding:0},onClick:Ua,id:"camera-capture-btn-lectores","aria-label":"Exportar captura de pantalla",children:e.jsx(dr,{size:16,color:"#234be7"})})]}):e.jsx(R,{children:"No hay lectores con coordenadas para mostrar en el mapa."})]})]})]}),e.jsx(jr,{opened:p,onClose:Ve,lector:G,onSave:ka}),e.jsx(fr,{opened:ba,onClose:Ue,onImport:Na}),e.jsx(vr,{opened:fa,onClose:Xe,selectedLectorIds:z,onSave:Ra,provincias:pe,localidades:Ie.map(a=>a.value),carreteras:he.map(a=>a.value),organismos:_e.map(a=>a.value),sentidos:["Creciente","Decreciente"]}),e.jsx(Cr,{opened:Sa,onClose:Ye,onExport:Ta,sugerencias:{provincias:pe,carreteras:he.map(a=>a.value),organismos:_e.map(a=>a.value),localidades:Ie.map(a=>a.value)}}),e.jsx(Ba,{}),e.jsx(A,{style:{display:"none"}})]})}export{Xr as default};
