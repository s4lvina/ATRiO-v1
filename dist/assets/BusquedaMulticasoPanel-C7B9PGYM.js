import{M as G,r as l,j as a,B as F,S as B,G as p,T as K,m as $,A as H,t as T,P as O,n as j,w as N,l as W,z as d}from"./index-B9r5cl9W.js";import{u as X,d as v,F as q}from"./FileSaver.min-Bz-SbG9W.js";import{u as k,w as Q}from"./xlsx-CwpDMyS9.js";import{M as Z}from"./MultiSelect-MjVHzexh.js";import{I as aa}from"./IconSearch-DHaK-uKX.js";import{S as ea}from"./SimpleGrid-D2l_HKT_.js";import{B as M}from"./Badge-0g_QzpBM.js";import{D as sa}from"./Divider-tgUTFFpg.js";import{P as ta}from"./Pagination-vgEYL1ab.js";/**
 * @license @tabler/icons-react v3.34.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var oa=G("outline","file-excel","IconFileExcel",[["path",{d:"M14 3v4a1 1 0 0 0 1 1h4",key:"svg-0"}],["path",{d:"M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2",key:"svg-1"}],["path",{d:"M10 12l4 5",key:"svg-2"}],["path",{d:"M10 17l4 -5",key:"svg-3"}]]);/**
 * @license @tabler/icons-react v3.34.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var ra=G("outline","file-word","IconFileWord",[["path",{d:"M14 3v4a1 1 0 0 0 1 1h4",key:"svg-0"}],["path",{d:"M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2",key:"svg-1"}],["path",{d:"M9 12l1.333 5l1.667 -4l1.667 4l1.333 -5",key:"svg-2"}]]);function ga(){const[n,m]=l.useState([]),[w,S]=l.useState([]),[A,u]=l.useState(!1),[I,g]=l.useState([]),[h,R]=l.useState(!0),[E]=X(w,500),[b,x]=l.useState(1),[L,y]=l.useState(1),f=9,[P,D]=l.useState(""),[Y]=X(P,500);l.useEffect(()=>{(async()=>{try{const t=await W.get("/casos",{params:{limit:100}});Array.isArray(t.data)?m(t.data):(m([]),d.show({title:"Error",message:"La respuesta del servidor de casos no es válida",color:"red"}))}catch(t){t.response&&t.response.status===401?(d.show({title:"Sesión expirada",message:"Por favor, vuelve a iniciar sesión.",color:"red"}),m([])):(d.show({title:"Error",message:"No se pudieron cargar los casos",color:"red"}),m([]))}finally{R(!1)}})()},[]);const V=async()=>{u(!0);try{const e=E.length>0?E.map(Number):n.map(c=>c.ID_Caso);if(!e.length){d.show({title:"Sin casos",message:"No hay casos seleccionados ni cargados.",color:"yellow"}),u(!1);return}const t={casos:e};Y.trim()!==""&&(t.matricula=Y.trim());const s=await W.post("/busqueda/multicaso",t);if(console.log("Respuesta del backend:",s.data),!Array.isArray(s.data)){d.show({title:"Error",message:"La respuesta del servidor no es válida",color:"red"}),g([]),y(1),x(1);return}g(s.data),y(Math.ceil(s.data.length/f)),x(1)}catch(e){e.response&&e.response.status===401?d.show({title:"Sesión expirada",message:"Por favor, vuelve a iniciar sesión.",color:"red"}):d.show({title:"Error",message:"No se pudo realizar la búsqueda",color:"red"}),g([]),y(1),x(1)}finally{u(!1)}},z=Array.isArray(I)?I:[],C=z.slice((b-1)*f,b*f),U=e=>{const t=e.casos.flatMap(r=>r.lecturas.map(i=>({Matrícula:i.Matricula,Caso:r.nombre,Fecha_y_Hora:v(i.Fecha_y_Hora).format("DD/MM/YYYY HH:mm:ss"),ID_Lector:i.ID_Lector,Carretera:i.Carretera||"",Provincia:i.Provincia||"",Localidad:i.Localidad||"",Coordenada_X:i.Coordenada_X??"",Coordenada_Y:i.Coordenada_Y??""})));if(t.length===0)return;const s=k.json_to_sheet(t),c=k.book_new();k.book_append_sheet(c,s,"Lecturas");const _=Q(c,{bookType:"xlsx",type:"array"}),o=new Blob([_],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});q.saveAs(o,`lecturas_${e.matricula}.xlsx`)},J=e=>{const t=e.casos.flatMap(o=>o.lecturas.map(r=>({Matrícula:r.Matricula,Caso:o.nombre,Fecha_y_Hora:v(r.Fecha_y_Hora).format("DD/MM/YYYY HH:mm:ss"),ID_Lector:r.ID_Lector,Carretera:r.Carretera||"",Provincia:r.Provincia||"",Localidad:r.Localidad||"",Coordenada_X:r.Coordenada_X??"",Coordenada_Y:r.Coordenada_Y??""})));if(t.length===0)return;let s="<table style='border-collapse:collapse;width:100%;font-family:Arial,sans-serif;font-size:12pt;'>";s+="<thead><tr><th style='border:1px solid black;padding:8px;'>Matrícula</th><th style='border:1px solid black;padding:8px;'>Caso</th><th style='border:1px solid black;padding:8px;'>Fecha y Hora</th><th style='border:1px solid black;padding:8px;'>ID Lector</th><th style='border:1px solid black;padding:8px;'>Carretera</th><th style='border:1px solid black;padding:8px;'>Provincia</th><th style='border:1px solid black;padding:8px;'>Localidad</th><th style='border:1px solid black;padding:8px;'>Coordenada X</th><th style='border:1px solid black;padding:8px;'>Coordenada Y</th></tr></thead><tbody>",t.forEach(o=>{s+="<tr>",s+=`<td style='border:1px solid black;padding:8px;'>${o.Matrícula}</td>`,s+=`<td style='border:1px solid black;padding:8px;'>${o.Caso}</td>`,s+=`<td style='border:1px solid black;padding:8px;'>${o.Fecha_y_Hora}</td>`,s+=`<td style='border:1px solid black;padding:8px;'>${o.ID_Lector}</td>`,s+=`<td style='border:1px solid black;padding:8px;'>${o.Carretera}</td>`,s+=`<td style='border:1px solid black;padding:8px;'>${o.Provincia}</td>`,s+=`<td style='border:1px solid black;padding:8px;'>${o.Localidad}</td>`,s+=`<td style='border:1px solid black;padding:8px;'>${o.Coordenada_X}</td>`,s+=`<td style='border:1px solid black;padding:8px;'>${o.Coordenada_Y}</td>`,s+="</tr>"}),s+="</tbody></table>";const c=`
      <html>
        <head>
          <meta charset='UTF-8'>
          <style>
            table { border-collapse: collapse; width: 100%; font-family: Arial, sans-serif; font-size: 12pt; }
            th, td { border: 1px solid black; padding: 8px; font-family: Arial, sans-serif; font-size: 12pt; }
          </style>
        </head>
        <body>${s}</body>
      </html>
    `,_=new Blob([c],{type:"application/msword"});q.saveAs(_,`lecturas_${e.matricula}.doc`)};return a.jsx(F,{children:a.jsxs(B,{gap:"md",children:[a.jsxs(p,{children:[a.jsx(K,{label:"Matrícula (opcional)",placeholder:"Introduce una matrícula",value:P,onChange:e=>D(e.target.value),style:{width:180},disabled:h}),a.jsx(Z,{label:"Seleccionar Casos (opcional)",placeholder:h?"Cargando casos...":n.length===0?"No hay casos disponibles":"Elige los casos a comparar",data:(n||[]).map(e=>({value:e.ID_Caso.toString(),label:`${e.Nombre_del_Caso} (${e.Año})`})),value:w,onChange:S,searchable:!0,clearable:!0,style:{flex:1},disabled:h||n.length===0}),a.jsx($,{leftSection:a.jsx(aa,{size:16}),onClick:V,loading:A,style:{marginTop:24},disabled:h||n.length===0,children:"Buscar Coincidencias"}),a.jsx($,{variant:"light",color:"gray",onClick:()=>{D(""),S([]),g([]),x(1)},style:{marginTop:24},disabled:A,children:"Limpiar"})]}),!h&&n.length===0&&a.jsx(H,{color:"yellow",icon:a.jsx(T,{size:16}),children:"No hay casos disponibles para seleccionar."}),Array.isArray(C)&&C.length>0&&a.jsxs(a.Fragment,{children:[a.jsxs(H,{icon:a.jsx(T,{size:16}),title:"Vehículos encontrados en múltiples casos",color:"blue",children:["Se encontraron ",z.length," vehículos que aparecen en más de un caso."]}),a.jsx(ea,{cols:3,spacing:"lg",children:C.map(e=>a.jsxs(O,{shadow:"md",p:"md",radius:"md",withBorder:!0,style:{minWidth:320,maxWidth:420,width:"100%"},children:[a.jsxs(p,{justify:"space-between",align:"flex-start",mb:"xs",children:[a.jsx(j,{size:"lg",fw:700,color:"blue.8",children:e.matricula}),a.jsxs(p,{gap:4,children:[a.jsxs(M,{color:"blue",variant:"light",children:[e.casos.length," caso",e.casos.length>1?"s":""]}),a.jsx(N,{variant:"light",color:"green",onClick:()=>U(e),title:"Exportar a Excel",children:a.jsx(oa,{size:20})}),a.jsx(N,{variant:"light",color:"blue",onClick:()=>J(e),title:"Exportar a Word (Arial 12)",children:a.jsx(ra,{size:20})})]})]}),a.jsx(sa,{my:6}),a.jsx(B,{gap:4,children:e.casos.map(t=>a.jsxs(F,{children:[a.jsxs(p,{justify:"space-between",align:"center",children:[a.jsx(j,{fw:600,size:"sm",children:t.nombre}),a.jsxs(M,{color:"gray",variant:"light",size:"sm",children:[t.lecturas.length," lecturas"]})]}),t.lecturas&&t.lecturas.length>0&&a.jsxs(p,{gap:6,mt:2,children:[t.lecturas.slice(0,3).map(s=>a.jsx(M,{color:"teal",variant:"outline",size:"xs",children:v(s.Fecha_y_Hora).format("DD/MM/YYYY HH:mm")},s.ID_Lectura)),t.lecturas.length>3&&a.jsxs(j,{size:"xs",c:"dimmed",children:["+",t.lecturas.length-3," más"]})]})]},t.id))})]},e.matricula))}),L>1&&a.jsx(p,{justify:"center",mt:"md",children:a.jsx(ta,{value:b,onChange:x,total:L,siblings:1,boundaries:1})})]})]})})}export{ga as B};
